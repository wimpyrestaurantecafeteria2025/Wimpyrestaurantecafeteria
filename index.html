<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wimpy App</title>
    <style>
        /* Estilos generales */
        body { font-family: Arial, sans-serif; background-color: #121212; color: #e0e0e0; margin: 0; padding: 0; }
        header { background-color: #1f1f1f; padding: 15px; text-align: center; font-size: 1.4em; color: #fff; }
        .main-nav { display: flex; justify-content: center; background-color: #1f1f1f; padding: 20px; gap: 20px; }
        /* Botones de navegaci√≥n principal y men√∫ de cliente */
        .main-nav button, #menu-cliente button, #admin-panel-menu nav button { 
            background-color: #4e44e2; 
            color: #fff; 
            border: none; 
            padding: 15px 30px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 1.1em; 
            transition: background-color 0.3s; 
            flex-grow: 1; 
        }
        .main-nav button:hover, #menu-cliente button:hover { background-color: #332a9e; }
        section { padding: 15px; }
        .oculto { display: none; }
        
        /* Estilos de Botones y Formularios */
        label { display: block; margin-top: 10px; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="number"], input[type="password"], textarea { width: 95%; padding: 10px; margin-bottom: 10px; border: 1px solid #333; border-radius: 4px; background-color: #2c2c2c; color: #e0e0e0; }
        .btn { background-color: #4e44e2; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px; }
        .btn-secondary { background-color: #555; }
        .btn-danger { background-color: #e24444; }
        .btn-whatsapp { background-color: #25D366; color: white; padding: 15px; font-size: 1.2em; margin-top: 20px; width: 100%; }

        /* Estilos del Carrito y Mensajes */
        .mensaje { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .mensaje.success { background-color: #44e24e50; border: 1px solid #44e24e; color: #fff; }
        .mensaje.error { background-color: #e2444450; border: 1px solid #e24444; color: #fff; }
        .pedido-card { background-color: #2c2c2c; padding: 10px; margin-bottom: 10px; border-radius: 6px; }
        
        /* Admin */
        #admin-panel-menu { margin-top: 20px; }
        #admin-panel-menu nav { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
    </style>
</head>
<body>

<header>Wimpy App</header>

<div id="vista-inicial" class="main-nav">
    <button onclick="iniciarSesionCliente()">üõí Clientes</button>
    <button onclick="accederAdmin()">üíº Administrador</button>
</div>

<section id="cliente" class="oculto">
    
    <div id="datos-cliente-form">
        <h2>üëã Ingrese su Tel√©fono</h2>
        <div id="clienteMessage" class="mensaje oculto"></div>
        <label for="telefonoCliente">Su Tel√©fono (WhatsApp):</label>
        <input type="number" id="telefonoCliente" oninput="validarTelefonoYBuscarInfo()" required>
        
        <div id="client-info-display" class="oculto" style="margin-top: 15px; padding: 10px; border: 1px solid #4e44e2; border-radius: 5px; background-color: #333;">
            <p>Cliente: <strong id="cliente-nombre-display"></strong></p>
            <p>Puntos Disponibles: <strong id="puntos-disponibles-display">0</strong></p>
        </div>

        <div style="margin-top: 15px; border: 1px dashed #555; padding: 10px; border-radius: 5px;">
            <input type="checkbox" id="autorizaDatos" style="transform: scale(1.2); margin-right: 5px;">
            <label for="autorizaDatos" style="display: inline;">Autorizo el tratamiento de mis datos personales seg√∫n la <a href="#" id="politicaLink" target="_blank" style="color: #4e44e2;">Pol√≠tica de Wimpy</a>.</label>
        </div>
        <button class="btn" onclick="iniciarPedido()" id="btn-iniciar-pedido" disabled>Acceder al Men√∫</button>
        <button class="btn btn-secondary" onclick="mostrar('vista-inicial')" style="width: 100%; margin-top: 15px;">‚¨ÖÔ∏è Regresar</button>
    </div>

    <div id="menu-cliente" class="oculto">
        <h2 style="text-align: center;"><span id="cliente-nombre-menu"></span>, ¬°qu√© bueno verte de nuevo!</h2>
        <div class="main-nav" style="flex-direction: column; padding: 10px 0;">
            <button onclick="mostrarAreaPedido()">üõí **Hacer Nuevo Pedido**</button>
            <button onclick="mostrarConfirmacionRecibido()">‚úÖ **Confirmar Recibido de Pedidos**</button>
            <button class="btn-secondary" onclick="iniciarSesionCliente()" style="background-color: #333; margin-top: 20px; color: #ccc;">‚¨ÖÔ∏è Cambiar Cliente / Salir</button>
        </div>
    </div>

    <div id="area-pedido" class="oculto">
        <h3 style="margin-top: 20px;">üçΩÔ∏è Men√∫ Disponible</h3>
        <div id="lista-productos">Cargando productos...</div>

        <h3 style="margin-top: 30px;">üõí Carrito de Compras</h3>
        <div id="carrito-items">El carrito est√° vac√≠o.</div>

        <div id="carrito-resumen">
            <div id="puntos-redencion-area" class="oculto">
                <label for="puntosACanjear" style="font-weight: normal; margin: 0;">Puntos a Canjear (1 punto = <span id="valor-punto-display"></span> COP):</label>
                <input type="number" id="puntosACanjear" value="0" min="0" oninput="renderizarCarrito()" style="width: 100px; padding: 5px; display: inline-block;">
                <hr style="border-top: 1px dashed #555; margin: 10px 0;">
            </div>
            <div><span>Subtotal (Neto):</span> <span id="subtotalPedido">$0 COP</span></div>
            <div><span>Descuento por Puntos:</span> <span id="descuentoPuntosInfo">$0 COP</span></div>
            <div style="border-top: 1px solid #555; padding-top: 10px; font-size: 1.2em; font-weight: bold;">
                <span>TOTAL FINAL A PAGAR:</span> <span id="totalFinalPedido">$0 COP</span>
            </div>
        </div>

        <button class="btn btn-whatsapp" onclick="enviarPedidoWhatsApp()" id="btn-enviar-pedido" disabled>
            <span style="font-size: 1.5em; margin-right: 10px;">üí¨</span> Enviar Pedido por WhatsApp
        </button>
        <button class="btn btn-secondary" onclick="iniciarPedido()" style="width: 100%; margin-top: 15px;">‚¨ÖÔ∏è Volver al Men√∫ Principal</button>
    </div>

    <div id="area-confirmar-recibido" class="oculto">
        <h3 style="margin-top: 20px;">‚úÖ Pedidos por Confirmar Recibido</h3>
        <div id="lista-pedidos-recibir">Cargando pedidos pendientes...</div>
        <button class="btn btn-secondary" onclick="iniciarPedido()" style="width: 100%; margin-top: 15px;">‚¨ÖÔ∏è Volver al Men√∫ Principal</button>
    </div>

</section>

<section id="admin" class="oculto">
    <h2>Panel de Administrador</h2>
    <div id="adminMessage" class="mensaje oculto"></div>
    
    <div id="admin-login">
        <label for="adminPin">PIN de Administrador:</label>
        <input type="password" id="adminPin">
        <button class="btn" onclick="iniciarSesionAdmin()">Acceder</button>
        <button class="btn btn-secondary" onclick="mostrar('vista-inicial')" style="width: 100%; margin-top: 15px;">‚¨ÖÔ∏è Regresar</button>
    </div>
    
    <div id="admin-panel-menu" class="oculto">
        <nav>
            <button onclick="mostrarAdminSection('configuracion')">‚öôÔ∏è Configuraci√≥n</button>
            <button onclick="mostrarAdminSection('clientes')">üë• Clientes</button>
            <button onclick="mostrarAdminSection('productos')">üçï Productos</button>
            <button onclick="mostrarAdminSection('historial')">üßæ Historial</button>
            <button onclick="mostrarAdminSection('mensajeria')">üìß Mensajer√≠a</button>
            <button class="btn-danger" onclick="adminLogout()" style="flex-grow: 0;">üîí Salir</button>
        </nav>
        <div id="admin-content">
            <p>Seleccione una opci√≥n del men√∫ superior.</p>
        </div>
    </div>
    <div id="configuracion" class="oculto admin-section">
        <h3>Configuraci√≥n General</h3>
        <label for="numeroWimpy">N√∫mero WhatsApp Wimpy:</label>
        <input type="text" id="numeroWimpy" value="57311XXXXXXX">
        <label for="valorPunto">Valor de 1 Punto (COP):</label>
        <input type="number" id="valorPunto" value="20">
        <button class="btn" onclick="guardarConfiguracion()">Guardar Configuraci√≥n</button>
    </div>
    <div id="clientes" class="oculto admin-section">
         <h3>Gesti√≥n de Clientes</h3>
         </div>
    <div id="productos" class="oculto admin-section">
        <h3>Gesti√≥n de Productos</h3>
         </div>
    <div id="historial" class="oculto admin-section">
        <h3>Historial de Pedidos</h3>
         </div>
    <div id="mensajeria" class="oculto admin-section">
        <h3>Mensajer√≠a</h3>
         </div>
</section>

<script>
// === CONFIGURACI√ìN CR√çTICA DEL SISTEMA ===
// **ATENCI√ìN: Debe reemplazar esta URL con la que obtenga de su Apps Script desplegado.**
const GOOGLE_SHEETS_API = 'https://script.google.com/macros/s/AKfycbwvbXwdh3xtkbHWsfwDTJ7BNU5A2fwIAWrGZ40j8w2UyzJeKh_lfQ6zcasIDqPOoSSYPQ/exec'; 
const ADMIN_PIN_SECRETO = "1995"; // PIN para acceder al panel. Cambiar por algo m√°s seguro.
const STORAGE_CONSENT = 'wimpy_data_consent'; 
let adminAcceso = false;
let puntosMaximos = 0; 
let valorPunto = 20; 
let clienteNombre = ''; 
let programaPuntosActivo = false; 
let carrito = []; 
let productosDisponibles = []; 

// Inicializar la App
document.addEventListener('DOMContentLoaded', () => {
    mostrar('vista-inicial');
    // cargarPoliticaUrl(); // Funci√≥n pendiente de implementar que carga la URL
});

// ------------------------------------------------------------------
// --- UTILIDADES GLOBALES Y NAVEGACI√ìN ---
// ------------------------------------------------------------------

function mostrar(seccion) {
    document.querySelectorAll('section, .main-nav, #datos-cliente-form, #menu-cliente, #area-pedido, #area-confirmar-recibido, #admin-login, #admin-panel-menu').forEach(s => s.classList.add('oculto'));
    document.getElementById(seccion).classList.remove('oculto');
}

function mostrarAdminSection(seccion) {
    document.querySelectorAll('.admin-section').forEach(s => s.classList.add('oculto'));
    const sectionElement = document.getElementById(seccion);
    if (sectionElement) {
        sectionElement.classList.remove('oculto');
        // Aqu√≠ se llamar√≠an funciones de carga espec√≠ficas (ej. cargarClientes(), cargarHistorial())
    }
}

function mostrarMensaje(id, texto, tipo) {
    const elemento = document.getElementById(id);
    elemento.innerHTML = texto;
    elemento.className = `mensaje ${tipo}`;
    elemento.classList.remove('oculto');
    setTimeout(() => {
        elemento.classList.add('oculto');
    }, 5000);
}

// ------------------------------------------------------------------
// --- CLIENTE: FLUJO DE ACCESO ---
// ------------------------------------------------------------------

function iniciarSesionCliente() {
    mostrar('cliente');
    document.getElementById('datos-cliente-form').classList.remove('oculto');
    document.getElementById('telefonoCliente').value = '';
    document.getElementById('btn-iniciar-pedido').disabled = true;
    document.getElementById('client-info-display').classList.add('oculto');
    clienteNombre = '';
    puntosMaximos = 0;
    carrito = []; // Limpiar carrito al salir/regresar al inicio
}

async function validarTelefonoYBuscarInfo() {
    const telefono = document.getElementById('telefonoCliente').value.trim();
    const btnIniciar = document.getElementById('btn-iniciar-pedido');
    const infoDisplay = document.getElementById('client-info-display');
    btnIniciar.disabled = true;
    infoDisplay.classList.add('oculto');
    
    if (telefono.length < 7) { 
        document.getElementById('clienteMessage').classList.add('oculto');
        return; 
    }
    
    mostrarMensaje('clienteMessage', 'Buscando cliente y estado de pedidos...', 'success');

    const formData = new FormData();
    formData.append('action', 'obtenerInfoCliente'); 
    formData.append('telefono', telefono);
    
    try {
        const response = await fetch(GOOGLE_SHEETS_API, { method: 'POST', body: formData });
        const data = await response.json();
        
        document.getElementById('clienteMessage').classList.add('oculto');

        if (data.success) {
            
            if (data.hasPendingOrders) {
                mostrarMensaje('clienteMessage', 'üö® **Pedido Pendiente:** Debe esperar la confirmaci√≥n del administrador antes de hacer un nuevo pedido.', 'error');
                return;
            }

            clienteNombre = data.nombre;
            puntosMaximos = data.puntos || 0;
            valorPunto = data.valorPunto || 20;
            programaPuntosActivo = data.programaPuntosActivo || false;

            document.getElementById('cliente-nombre-display').textContent = clienteNombre;
            document.getElementById('puntos-disponibles-display').textContent = puntosMaximos.toLocaleString('es-CO') + ' pts';
            infoDisplay.classList.remove('oculto');
            
            if (programaPuntosActivo) {
                 document.getElementById('valor-punto-display').textContent = valorPunto.toLocaleString('es-CO');
            }

            btnIniciar.disabled = false; 

        } else {
             mostrarMensaje('clienteMessage', 'Cliente no registrado o error: ' + (data.error || 'Desconocido'), 'error');
        }

    } catch (error) {
        mostrarMensaje('clienteMessage', 'Error de conexi√≥n con la API.', 'error');
    }
}

function iniciarPedido() {
    const telefono = document.getElementById("telefonoCliente").value.trim();
    const autorizaDatos = document.getElementById("autorizaDatos").checked;
    
    if (!telefono || !clienteNombre || document.getElementById('btn-iniciar-pedido').disabled) {
        // Esto previene el click si no se ha validado el tel√©fono
        mostrarMensaje('clienteMessage', 'El tel√©fono no ha sido validado o tiene pedidos pendientes.', 'error');
        return;
    }

    if (!autorizaDatos) {
        mostrarMensaje('clienteMessage', 'Debe autorizar el tratamiento de datos para continuar.', 'error');
        return;
    }
    
    // Transici√≥n al Men√∫ Principal del Cliente
    document.getElementById('datos-cliente-form').classList.add('oculto');
    document.getElementById('area-pedido').classList.add('oculto');
    document.getElementById('area-confirmar-recibido').classList.add('oculto');
    document.getElementById('menu-cliente').classList.remove('oculto');

    // Implementaci√≥n del saludo personalizado
    document.getElementById('cliente-nombre-menu').textContent = clienteNombre;

    localStorage.setItem(STORAGE_CONSENT, 'true');
}

function mostrarAreaPedido() {
    document.getElementById('menu-cliente').classList.add('oculto');
    document.getElementById('area-pedido').classList.remove('oculto');

    // L√≥gica para cargar productos y configurar redenci√≥n de puntos...
    // Las funciones cargarProductosCliente, renderizarCarrito, etc., deben estar completas
}

function mostrarConfirmacionRecibido() {
    document.getElementById('menu-cliente').classList.add('oculto');
    document.getElementById('area-confirmar-recibido').classList.remove('oculto');
    
    // L√≥gica para buscar pedidos pendientes de confirmar...
}

// ------------------------------------------------------------------
// --- ADMINISTRADOR: FLUJO DE ACCESO ---
// ------------------------------------------------------------------

function accederAdmin() {
    mostrar('admin');
    document.getElementById('admin-login').classList.remove('oculto');
    document.getElementById('admin-panel-menu').classList.add('oculto');
    document.getElementById('adminPin').value = '';
}

function iniciarSesionAdmin() {
    const pin = document.getElementById('adminPin').value.trim();
    if (pin === ADMIN_PIN_SECRETO) {
        adminAcceso = true;
        document.getElementById('admin-login').classList.add('oculto');
        document.getElementById('admin-panel-menu').classList.remove('oculto');
        mostrarMensaje('adminMessage', 'Acceso concedido. Bienvenido.', 'success');
        mostrarAdminSection('configuracion'); // Mostrar configuraci√≥n por defecto
    } else {
        mostrarMensaje('adminMessage', 'PIN incorrecto. Intente de nuevo.', 'error');
        adminAcceso = false;
    }
}

function adminLogout() {
    adminAcceso = false;
    mostrar('vista-inicial');
}

// ... (Resto de funciones de carrito, env√≠o, y admin deben completarse) ...
// (La funci√≥n renderizarCarrito y otras dependen de productosDisponibles y carrito)

</script>
</body>
</html>
