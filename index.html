<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üçî‚òï WimpyApp</title>
<style>
  :root{--bg:#0b0c10;--card:#0f1114;--muted:#9aa0a6;--accent:#ff6b35;--text:#e6eef3;}
  *{box-sizing:border-box;font-family:Inter,system-ui,Arial;margin:0;padding:0}
  body{background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
  header{display:flex;align-items:center;gap:12px;padding:14px;background:linear-gradient(90deg,#081018,#0d1114)}
  .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(180deg,#ff8a4c,#ff6b35);display:flex;align-items:center;justify-content:center;font-size:1.1rem}
  .container{max-width:980px;margin:18px auto;padding:12px}
  .panel{background:var(--card);border:1px solid #151618;padding:16px;border-radius:12px}
  .row{display:flex;gap:12px;align-items:center}
  .col{display:flex;flex-direction:column;gap:8px}
  button{background:linear-gradient(90deg,var(--accent),#ff9a57);color:white;border:0;padding:10px 12px;border-radius:10px;cursor:pointer}
  .btn-ghost{background:transparent;border:1px solid #222;color:var(--text);padding:8px;border-radius:8px}
  input,select,textarea{background:#0c0d0f;color:var(--text);border:1px solid #1b1c1e;padding:10px;border-radius:8px}
  .muted{color:var(--muted);font-size:0.92rem}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
  .tab{background:#0b0c0e;padding:8px 10px;border-radius:8px;border:1px solid #151617;cursor:pointer}
  .tab.active{box-shadow:0 6px 18px rgba(0,0,0,.6);border-color:rgba(255,255,255,.04)}
  .grid{display:grid;gap:12px}
  .grid.cols-3{grid-template-columns:repeat(3,1fr)}
  .card{background:#0b0c0e;border:1px solid #151617;padding:10px;border-radius:10px}
  .small{padding:6px 8px;font-size:0.9rem}
  footer{margin-top:18px;text-align:center;color:var(--muted);font-size:0.9rem}
  .hidden{display:none}
  @media (max-width:800px){ .grid.cols-3{grid-template-columns:repeat(1,1fr)} .row{flex-direction:column;align-items:stretch} }
</style>
</head>
<body>
  <header>
    <div class="logo">üçî‚òï</div>
    <div>
      <h2 style="margin:0">WimpyApp</h2>
      <div class="muted">Pedidos ‚Ä¢ Fidelizaci√≥n ‚Ä¢ Facturaci√≥n</div>
    </div>
  </header>

  <main class="container">
    <div class="panel">
      <div class="tabs" id="mainTabs">
        <div class="tab active" data-view="inicio">Inicio</div>
        <div class="tab" data-view="cliente">Cliente</div>
        <div class="tab" data-view="admin">Administrador</div>
      </div>

      <div id="viewContainer">
        <!-- INICIO -->
        <div id="inicioView">
          <h3>Bienvenido a WimpyApp</h3>
          <p class="muted">Selecciona Cliente o Administrador para comenzar.</p>
        </div>

        <!-- CLIENTE -->
        <div id="clienteView" class="hidden">
          <div class="grid" style="gap:12px">
            <div class="card">
              <h4>Acceso Cliente</h4>
              <div class="row" style="gap:8px;margin-top:8px">
                <input id="cliTelefono" placeholder="Tel√©fono (ej: 3118336562)" />
                <button id="btnGenerarOtp">Generar PIN (gratis)</button>
              </div>

              <div id="otpArea" class="hidden" style="margin-top:10px">
                <div class="muted">PIN generado (v√°lido 3 minutos):</div>
                <div style="font-size:1.6rem;font-weight:700" id="otpValor"></div>

                <div style="margin-top:8px;display:flex;gap:8px">
                  <input id="pinInput" placeholder="Ingresa el PIN" style="width:160px" />
                  <button id="btnIngresarConOtp">Ingresar con PIN</button>
                  <button id="btnWaVerify" class="btn-ghost">Enviar PIN por mi WhatsApp (opcional)</button>
                </div>

                <div class="muted" style="margin-top:8px">Si pulsas "Enviar PIN por mi WhatsApp" se abrir√° tu WhatsApp con un mensaje prellenado que t√∫ enviar√°s ‚Äîesto prueba que el n√∫mero es tuyo.</div>
              </div>
            </div>

            <div id="clienteMenu" class="card hidden">
              <h4>Cliente: <span id="clienteNombreShow"></span></h4>
              <div class="row" style="justify-content:space-between;align-items:center">
                <div class="muted">Puntos disponibles: <strong id="clientePuntos">0</strong></div>
                <div>
                  <button id="btnCerrarSesion" class="btn-ghost small">Cerrar sesi√≥n</button>
                </div>
              </div>

              <div style="margin-top:12px">
                <div style="display:flex;gap:8px">
                  <button id="clientePedidosBtn" class="small">Pedidos</button>
                  <button id="clienteConfirmBtn" class="small">Confirmar entrega</button>
                </div>

                <div id="clientePedidosView" class="hidden" style="margin-top:12px">
                  <div class="row" style="justify-content:space-between;align-items:center">
                    <h5>Men√∫</h5>
                    <div class="row">
                      <input id="searchProductosCliente" placeholder="Buscar..." />
                      <button id="refreshProducts" class="btn-ghost small">Refrescar</button>
                    </div>
                  </div>

                  <div id="productosListCliente" class="grid cols-3" style="margin-top:10px"></div>

                  <div style="margin-top:12px" class="card">
                    <h5>Carrito</h5>
                    <div id="carritoListCliente"></div>
                    <div class="row" style="justify-content:space-between;align-items:center;margin-top:8px">
                      <div class="muted">Total: <strong id="totalCliente">$0</strong></div>
                      <div style="display:flex;gap:8px">
                        <button id="btnAplicarPuntos" class="btn-ghost">Usar mis puntos</button>
                        <button id="btnEnviarPedido" class="btn">Confirmar compra</button>
                      </div>
                    </div>
                  </div>
                </div>

                <div id="clienteConfirmView" class="hidden" style="margin-top:12px">
                  <h5>Confirmar entrega</h5>
                  <div class="muted">Selecciona el pedido que recibiste:</div>
                  <div id="pedidosPendientesCliente" style="margin-top:8px"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ADMIN -->
        <div id="adminView" class="hidden">
          <div class="grid" style="gap:12px">
            <div class="card">
              <h4>Acceso Administrador</h4>
              <div class="row" style="gap:8px;margin-top:8px">
                <input id="adminPin" placeholder="PIN administrador" />
                <button id="btnAdminLogin">Ingresar</button>
              </div>
              <div class="muted" style="margin-top:8px">PIN por defecto: <strong>1995</strong></div>
              <div id="adminStatus" class="muted" style="margin-top:6px"></div>
            </div>

            <div id="adminPanel" class="hidden">
              <div class="card">
                <h4>Admin Panel</h4>
                <div style="display:flex;gap:8px;flex-wrap:wrap">
                  <button class="tab small" data-adminview="dashboard">Dashboard</button>
                  <button class="tab small" data-adminview="productos">Productos</button>
                  <button class="tab small" data-adminview="clientes">Clientes</button>
                  <button class="tab small" data-adminview="pedidos">Pedidos</button>
                  <button class="tab small" data-adminview="facturacion">Cuentas de cobro</button>
                  <button class="tab small" data-adminview="fidelizacion">Fidelizaci√≥n</button>
                  <button class="tab small" data-adminview="configuracion">Configuraci√≥n</button>
                  <button class="tab small" data-adminview="backups">Backups</button>
                </div>

                <div id="adminViewsArea" style="margin-top:12px">
                  <!-- Dashboard -->
                  <div id="admin_dashboard" class="hidden">
                    <h5>Dashboard</h5>
                    <div class="row" style="gap:12px;margin-top:8px">
                      <div class="card">Pedidos totales: <div id="stat_total">0</div></div>
                      <div class="card">Pendientes: <div id="stat_pend">0</div></div>
                      <div class="card">Entregados: <div id="stat_ent">0</div></div>
                      <div class="card">Puntos emitidos: <div id="stat_pts">0</div></div>
                    </div>
                  </div>

                  <!-- Productos -->
                  <div id="admin_productos" class="hidden">
                    <h5>Productos</h5>
                    <div style="display:flex;gap:8px;margin-top:8px">
                      <input id="prodNombre" placeholder="Nombre producto"/>
                      <input id="prodPrecio" placeholder="Precio entero"/>
                      <input id="prodCategoria" placeholder="Categor√≠a (ej: Cafeter√≠a)"/>
                      <button id="btnAddProd">Agregar</button>
                    </div>
                    <div id="productosAdminList" style="margin-top:10px"></div>
                  </div>

                  <!-- Clientes -->
                  <div id="admin_clientes" class="hidden">
                    <h5>Clientes</h5>
                    <div style="display:flex;gap:8px;margin-top:8px">
                      <input id="cliNombreAdmin" placeholder="Nombre"/>
                      <input id="cliTelefonoAdmin" placeholder="Tel√©fono"/>
                      <input id="cliEmailAdmin" placeholder="Email (opcional)"/>
                      <button id="btnAddClienteAdmin">Agregar</button>
                    </div>
                    <div id="clientesAdminList" style="margin-top:10px"></div>
                  </div>

                  <!-- Pedidos -->
                  <div id="admin_pedidos" class="hidden">
                    <h5>Pedidos</h5>
                    <div style="display:flex;gap:8px;margin-top:8px">
                      <select id="filtroPedidos">
                        <option value="todos">Todos</option>
                        <option value="pendiente">Pendiente</option>
                        <option value="aprobado">Aprobado</option>
                        <option value="entregado">Entregado</option>
                        <option value="cancelado">Cancelado</option>
                      </select>
                      <button id="btnRefreshHist">Refrescar</button>
                    </div>
                    <div id="pedidosAdminList" style="margin-top:10px"></div>
                  </div>

                  <!-- Facturaci√≥n -->
                  <div id="admin_facturacion" class="hidden">
                    <h5>Cuentas de cobro</h5>
                    <div style="display:flex;gap:8px;margin-top:8px">
                      <input id="factMes" type="month" />
                      <button id="btnGenPdfMensual">Generar PDF mensual (Total)</button>
                      <button id="btnGenExcelMensual">Generar Excel detalle por empleado</button>
                    </div>
                    <div id="factLinks" style="margin-top:8px"></div>
                    <div style="margin-top:12px">
                      <h6>Generar cuenta individual:</h6>
                      <input id="invoiceTimestamp" placeholder="Timestamp pedido" />
                      <button id="btnGenInvoice">Generar cuenta (pedido)</button>
                    </div>
                  </div>

                  <!-- Fidelizaci√≥n -->
                  <div id="admin_fidelizacion" class="hidden">
                    <h5>Fidelizaci√≥n y Promociones</h5>
                    <div class="muted">Promociones activas</div>
                    <div style="display:flex;gap:8px;margin-top:8px">
                      <input id="promoNombre" placeholder="Nombre promo (ej: Viernes de Caf√©)"/>
                      <input id="promoFiltro" placeholder="Filtro palabra (ej: caf√©)"/>
                      <input id="promoMult" placeholder="Multiplicador (ej: 2)"/>
                      <button id="btnAddPromo">Agregar promo</button>
                    </div>
                    <div id="promosList" style="margin-top:10px"></div>
                    <div style="margin-top:12px" class="muted">Bono cumplea√±os: aplica autom√°ticamente.</div>
                  </div>

                  <!-- Configuraci√≥n -->
                  <div id="admin_configuracion" class="hidden">
                    <h5>Configuraci√≥n Wimpy</h5>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
                      <input id="cfgNumeroWimpy" placeholder="N√∫mero WhatsApp Wimpy (ej: 573118336562)"/>
                      <input id="cfgNombreW" placeholder="Nombre empresa (Wimpy)"/>
                      <input id="cfgNIT" placeholder="NIT Wimpy"/>
                      <input id="cfgEmpresaNombre" placeholder="Empresa contratante (nombre)"/>
                      <input id="cfgEmpresaNIT" placeholder="NIT empresa"/>
                      <input id="cfgCodigoEmpresa" placeholder="C√≥digo empresa (2 d√≠gitos)"/>
                      <button id="btnGuardarCfg">Guardar</button>
                      <button id="btnCargarCfg" class="btn-ghost">Cargar actual</button>
                    </div>
                  </div>

                  <!-- Backups -->
                  <div id="admin_backups" class="hidden">
                    <h5>Backups</h5>
                    <div style="display:flex;gap:8px;margin-top:8px">
                      <button id="btnBackupNow">Crear backup ahora</button>
                      <button id="btnCrearTrigger" class="btn-ghost">Crear trigger diario</button>
                    </div>
                    <div id="backupLog" style="margin-top:8px"></div>
                  </div>

                </div>
              </div>
            </div>

          </div>
        </div>

      </div>
    </div>
  </main>

  <footer>WimpyApp ‚Ä¢ Hecho para administraci√≥n empresarial</footer>

<script>
/* ================== CONFIG ================== */
const GOOGLE_SHEETS_API = 'https://script.google.com/macros/s/AKfycbwvbXwdh3xtkbHWsfwDTJ7BNU5A2fwIAWrGZ40j8w2UyzJeKh_lfQ6zcasIDqPOoSSYPQ/exec';
const ADMIN_PIN = '1995';
/* ============================================ */

let productos = [], clientes = [], historial = [], promos = [];
let clienteSesion = null;
let carrito = [];
let puntosAplicados = 0;
let NUMERO_WIMPY = '573118336562';

const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const esc = t => String(t||'');
async function getJSON(q){
  try{
    const r = await fetch(q, {cache:'no-store'});
    return await r.json();
  } catch(e){ console.error('fetch error',e); return null; }
}

/* ---------- Tabs ---------- */
$$('.tab[data-view]').forEach(t=>{
  t.addEventListener('click', ()=>{
    $$('.tab[data-view]').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    const view = t.dataset.view;
    $('#inicioView').classList.toggle('hidden', view!=='inicio');
    $('#clienteView').classList.toggle('hidden', view!=='cliente');
    $('#adminView').classList.toggle('hidden', view!=='admin');
  });
});

/* ---------- CLIENTE: OTP ---------- */
$('#btnGenerarOtp').addEventListener('click', async ()=>{
  const tel = $('#cliTelefono').value.trim();
  if (!tel) return alert('Ingresa tel√©fono');
  const res = await getJSON(`${GOOGLE_SHEETS_API}?action=generarOTP&telefono=${encodeURIComponent(tel)}`);
  if (res && res.success){
    $('#otpArea').classList.remove('hidden');
    $('#otpValor').textContent = res.pin;
    $('#pinInput').value = '';
    // hide after 3 minutes
    setTimeout(()=>{ $('#otpArea').classList.add('hidden'); $('#otpValor').textContent=''; }, 180000);
    $('#btnWaVerify').onclick = ()=>{
      // open wa.me to NUMERO_WIMPY (from config if available)
      const numero = window.NUMERO_WIMPY || NUMERO_WIMPY;
      const text = `WIMPY OTP REQUEST: ${res.pin}`;
      window.open(`https://wa.me/${numero}?text=${encodeURIComponent(text)}`, '_blank');
    };
  } else alert('Error generando PIN');
});

$('#btnIngresarConOtp').addEventListener('click', async ()=>{
  const tel = $('#cliTelefono').value.trim();
  const pin = $('#pinInput').value.trim();
  if (!tel || !pin) return alert('Tel√©fono y PIN requeridos');
  const res = await getJSON(`${GOOGLE_SHEETS_API}?action=validarOTP&telefono=${encodeURIComponent(tel)}&pin=${encodeURIComponent(pin)}`);
  if (res && res.success){
    clienteSesion = { telefono: tel, nombre: res.nombre || ('Cliente ' + tel) };
    $('#clienteNombreShow').textContent = clienteSesion.nombre;
    $('#clientePuntos').textContent = res.saldo || 0;
    $('#clienteMenu').classList.remove('hidden');
    $('#otpArea').classList.add('hidden');
    $('#pinInput').value = '';
    showClientePedidos(); // default to pedidos view
  } else {
    alert(res && res.message ? res.message : 'PIN inv√°lido o expirado');
  }
});

$('#btnCerrarSesion').addEventListener('click', ()=>{
  clienteSesion = null; carrito = []; $('#clienteMenu').classList.add('hidden');
});

/* ---------- CLIENTE: pedidos / carrito ---------- */
$('#clientePedidosBtn').addEventListener('click', ()=>{ $('#clienteConfirmView').classList.add('hidden'); $('#clientePedidosView').classList.remove('hidden'); renderProductosLista(); });
$('#clienteConfirmBtn').addEventListener('click', ()=>{ $('#clientePedidosView').classList.add('hidden'); $('#clienteConfirmView').classList.remove('hidden'); cargarPedidosCliente(); });

$('#refreshProducts').addEventListener('click', async ()=>{ await loadProductos(); renderProductosLista(); });

async function loadProductos(){ const r = await getJSON(`${GOOGLE_SHEETS_API}?action=obtenerProductos`); productos = (r && r.success) ? r.productos : []; }
async function loadClientes(){ const r = await getJSON(`${GOOGLE_SHEETS_API}?action=obtenerClientes`); clientes = (r && r.success) ? r.clientes : []; }
async function loadHistorial(){ const r = await getJSON(`${GOOGLE_SHEETS_API}?action=obtenerHistorial`); historial = (r && r.success) ? r.historial : []; }
async function loadPromos(){ const r = await getJSON(`${GOOGLE_SHEETS_API}?action=obtenerPromos`); promos = (r && r.success) ? r.promos : []; }

async function renderProductosLista(){
  await loadProductos();
  const q = $('#searchProductosCliente').value.trim().toLowerCase();
  const node = $('#productosListCliente'); node.innerHTML = '';
  const lista = productos.filter(p => (p.activo === 'SI' || p.activo === true || p.activo === 'TRUE'));
  const fil = lista.filter(p => !q || (p.nombreProducto||'').toLowerCase().includes(q));
  if (!fil.length){ node.innerHTML = '<div class="muted">No hay productos</div>'; return; }
  fil.forEach(p=>{
    const el = document.createElement('div'); el.className='card';
    el.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <div><div style="font-weight:700">${esc(p.nombreProducto)}</div><div class="muted">$ ${Number(p.precio).toLocaleString('es-CO')}</div></div>
      <div style="display:flex;flex-direction:column;gap:6px">
        <input type="number" min="1" value="1" style="width:80px;padding:6px;border-radius:6px;background:#0c0d0f;color:var(--text)" data-id="${p.IDProducto}" />
        <button data-add="${p.IDProducto}" class="small">A√±adir</button>
      </div>
    </div>`;
    node.appendChild(el);
  });
  node.querySelectorAll('button[data-add]').forEach(b=>{
    b.addEventListener('click', ()=>{
      const id = b.dataset.add;
      const input = b.parentElement.querySelector('input');
      const qty = parseInt(input.value,10) || 1;
      const prod = productos.find(x=> String(x.IDProducto)===String(id));
      if (prod) addToCart(prod, qty);
    });
  });
}

function addToCart(prod, qty){
  const found = carrito.find(i=> String(i.id)===String(prod.IDProducto));
  if (found) found.cantidad += qty;
  else carrito.push({ id:prod.IDProducto, nombre:prod.nombreProducto, precio:parseInt(prod.precio,10)||0, cantidad:qty });
  renderCarrito();
}

function renderCarrito(){
  const node = $('#carritoListCliente'); node.innerHTML = '';
  if (!carrito.length){ node.innerHTML = '<div class="muted">Carrito vac√≠o</div>'; $('#totalCliente').textContent='$0'; return; }
  let total = 0;
  carrito.forEach((it, idx)=>{
    total += it.precio * it.cantidad;
    const el = document.createElement('div'); el.style.display='flex'; el.style.justifyContent='space-between'; el.style.marginBottom='8px';
    el.innerHTML = `<div>${esc(it.nombre)} <span class="muted">x${it.cantidad}</span></div><div>$${Number(it.precio*it.cantidad).toLocaleString('es-CO')}</div>`;
    node.appendChild(el);
  });
  $('#totalCliente').textContent = `$${Number(total).toLocaleString('es-CO')}`;
}

$('#btnAplicarPuntos').addEventListener('click', async ()=>{
  if (!clienteSesion) return alert('Ingresa primero con tu PIN');
  const res = await getJSON(`${GOOGLE_SHEETS_API}?action=getSaldoPuntos&telefono=${encodeURIComponent(clienteSesion.telefono)}`);
  if (res && res.success){
    const saldo = parseInt(res.saldo || 0,10);
    if (!saldo) return alert('No tienes puntos disponibles');
    const use = parseInt(prompt(`Tienes ${saldo} puntos. ¬øCu√°ntos quieres usar? (solo enteros)`,'0'),10);
    if (!use || use<=0) return;
    if (use>saldo) return alert('No tienes tantos puntos');
    puntosAplicados = use;
    alert(`Se aplicar√°n ${use} puntos al siguiente pago`);
  } else alert('Error obteniendo saldo');
});

$('#btnEnviarPedido').addEventListener('click', async ()=>{
  if (!clienteSesion) return alert('Ingresa primero');
  if (!carrito.length) return alert('Carrito vac√≠o');
  const detalle = carrito.map(i=> ({ id:i.id, nombre:i.nombre, precio:i.precio, cantidad:i.cantidad }));
  const total = carrito.reduce((s,i)=> s + (i.precio*i.cantidad), 0);
  const payload = `${GOOGLE_SHEETS_API}?action=registrarPedido&telefono=${encodeURIComponent(clienteSesion.telefono)}&nombre=${encodeURIComponent(clienteSesion.nombre||'')}&detalleJSON=${encodeURIComponent(JSON.stringify(detalle))}&total=${encodeURIComponent(total)}&puntosAplicados=${encodeURIComponent(puntosAplicados||0)}`;
  const res = await getJSON(payload);
  if (res && res.success){
    alert('Pedido registrado. Se enviar√° notificaci√≥n a Wimpy. Qued√≥ como PENDIENTE.');
    carrito = []; puntosAplicados = 0;
    renderCarrito();
    await loadHistorial();
  } else alert('Error registrando pedido');
});

/* ---------- CLIENTE: Confirmar entrega ---------- */
async function cargarPedidosCliente(){
  await loadHistorial();
  const node = $('#pedidosPendientesCliente'); node.innerHTML = '';
  const tel = clienteSesion ? clienteSesion.telefono : $('#cliTelefono').value.trim();
  const lista = historial.filter(h => (h.telefono||'').indexOf(tel)!==-1 && (h.estado==='aprobado' || h.estado==='pendiente'));
  if (!lista.length){ node.innerHTML = '<div class="muted">No hay pedidos</div>'; return; }
  lista.forEach(h=>{
    const el = document.createElement('div'); el.className='card';
    el.innerHTML = `<div style="display:flex;justify-content:space-between">
      <div><div style="font-weight:700">${esc(h.detalleResumen || h.detalle)}</div><div class="muted">${esc(h.fecha)} ‚Ä¢ ${esc(h.hora)}</div></div>
      <div style="display:flex;flex-direction:column;gap:6px">
        <div class="muted">Total: $${Number(h.total).toLocaleString('es-CO')}</div>
        ${h.estado!=='entregado' ? `<button data-confirm="${h.timestamp}" class="small">Confirmar entrega</button>` : `<div class="muted">Estado: ${h.estado}</div>`}
      </div>
    </div>`;
    node.appendChild(el);
  });
  node.querySelectorAll('button[data-confirm]').forEach(b=>{
    b.addEventListener('click', async ()=>{
      const ts = b.dataset.confirm;
      if (!confirm('Confirmar que recibiste el pedido?')) return;
      const res = await getJSON(`${GOOGLE_SHEETS_API}?action=confirmarEntrega&timestamp=${encodeURIComponent(ts)}&telefono=${encodeURIComponent(clienteSesion.telefono)}`);
      if (res && res.success){
        alert('Entrega confirmada. Gracias.');
        await loadHistorial(); cargarPedidosCliente();
        const saldo = await getJSON(`${GOOGLE_SHEETS_API}?action=getSaldoPuntos&telefono=${encodeURIComponent(clienteSesion.telefono)}`);
        $('#clientePuntos').textContent = saldo.saldo || 0;
      } else alert('Error confirmando entrega');
    });
  });
}

/* ---------- ADMIN ---------- */
$('#btnAdminLogin').addEventListener('click', async ()=>{
  const pin = $('#adminPin').value.trim();
  if (pin === ADMIN_PIN){
    $('#adminPin').value = '';
    $('#adminStatus').textContent = 'Sesi√≥n activa como administrador ‚úÖ';
    $('#adminPanel').classList.remove('hidden');
    $('#admin_dashboard').classList.remove('hidden');
    await loadAllAdmin();
  } else alert('PIN incorrecto');
});

async function loadAllAdmin(){ await loadProductos(); await loadClientes(); await loadHistorial(); await loadPromos(); renderAdminProductos(); renderAdminClientes(); renderAdminPedidos(); renderPromos(); renderStats(); }

$$('.tab.small[data-adminview]').forEach(b=>{
  b.addEventListener('click', ()=>{
    const v = b.dataset.adminview;
    ['dashboard','productos','clientes','pedidos','facturacion','fidelizacion','configuracion','backups'].forEach(x=> $('#admin_'+x).classList.add('hidden'));
    $('#admin_'+v).classList.remove('hidden');
    if (v==='productos') renderAdminProductos();
    if (v==='clientes') renderAdminClientes();
    if (v==='pedidos') renderAdminPedidos();
    if (v==='fidelizacion') renderPromos();
    if (v==='configuracion') loadConfig();
    if (v==='dashboard') renderStats();
  });
});

/* Productos admin */
$('#btnAddProd').addEventListener('click', async ()=>{
  const nombre = $('#prodNombre').value.trim();
  const precio = parseInt($('#prodPrecio').value.trim(),10);
  const categoria = $('#prodCategoria').value.trim();
  if (!nombre || isNaN(precio)) return alert('Nombre y precio (entero)');
  const res = await getJSON(`${GOOGLE_SHEETS_API}?action=agregarProducto&nombre=${encodeURIComponent(nombre)}&precio=${encodeURIComponent(precio)}&categoria=${encodeURIComponent(categoria)}`);
  if (res && res.success){ $('#prodNombre').value=''; $('#prodPrecio').value=''; $('#prodCategoria').value=''; await loadProductos(); renderAdminProductos(); } else alert('Error');
});
async function renderAdminProductos(){
  await loadProductos();
  const node = $('#productosAdminList'); node.innerHTML = '';
  productos.forEach(p=>{
    const el = document.createElement('div'); el.className='card';
    el.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <div><div style="font-weight:700">${esc(p.nombreProducto)}</div><div class="muted">C: ${esc(p.categoria)} ‚Ä¢ $${Number(p.precio).toLocaleString('es-CO')}</div></div>
      <div style="display:flex;flex-direction:column;gap:6px">
        <button data-edit="${p.IDProducto}" class="btn-ghost small">Editar</button>
        <button data-del="${p.IDProducto}" class="btn-ghost small">Eliminar</button>
      </div>
    </div>`;
    node.appendChild(el);
  });
  node.querySelectorAll('button[data-del]').forEach(b=> b.addEventListener('click', async ()=>{ if(!confirm('Eliminar producto?')) return; const id=b.dataset.del; const res=await getJSON(`${GOOGLE_SHEETS_API}?action=eliminarProducto&id=${encodeURIComponent(id)}`); if (res && res.success){ await loadProductos(); renderAdminProductos(); } else alert('Error'); }));
  node.querySelectorAll('button[data-edit]').forEach(b=> b.addEventListener('click', async ()=>{ const id=b.dataset.edit; const p=productos.find(x=>String(x.IDProducto)===String(id)); if(!p) return; const nuevo = prompt('Nuevo precio entero para ' + p.nombreProducto, p.precio); if (nuevo===null) return; const price = parseInt(nuevo,10); if (isNaN(price)) return alert('Precio inv√°lido'); const res = await getJSON(`${GOOGLE_SHEETS_API}?action=editarProducto&id=${encodeURIComponent(id)}&precio=${encodeURIComponent(price)}`); if (res && res.success) await loadProductos(), renderAdminProductos(); else alert('Error'); }));
}

/* Clientes admin */
$('#btnAddClienteAdmin').addEventListener('click', async ()=>{
  const nombre = $('#cliNombreAdmin').value.trim();
  const telefono = $('#cliTelefonoAdmin').value.trim();
  const email = $('#cliEmailAdmin').value.trim();
  if (!nombre || !telefono) return alert('Nombre y tel√©fono');
  const res = await getJSON(`${GOOGLE_SHEETS_API}?action=agregarCliente&telefono=${encodeURIComponent(telefono)}&nombre=${encodeURIComponent(nombre)}&email=${encodeURIComponent(email)}`);
  if (res && res.success){ $('#cliNombreAdmin').value=''; $('#cliTelefonoAdmin').value=''; $('#cliEmailAdmin').value=''; await loadClientes(); renderAdminClientes(); } else alert(res.message||'Error');
});
async function renderAdminClientes(){
  await loadClientes();
  const node = $('#clientesAdminList'); node.innerHTML = '';
  clientes.forEach(c=>{
    const el = document.createElement('div'); el.className='card';
    el.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <div><div style="font-weight:700">${esc(c.nombre)}</div><div class="muted">${esc(c.telefono)}</div></div>
      <div><div class="muted">${esc(c.email||'')}</div></div>
    </div>`;
    node.appendChild(el);
  });
}

/* Pedidos admin */
$('#btnRefreshHist').addEventListener('click', renderAdminPedidos);
async function renderAdminPedidos(){
  await loadHistorial();
  const filtro = $('#filtroPedidos').value;
  const node = $('#pedidosAdminList'); node.innerHTML = '';
  const lista = historial.filter(h => filtro==='todos' ? true : h.estado===filtro);
  if (!lista.length){ node.innerHTML = '<div class="muted">Sin pedidos</div>'; return; }
  lista.slice().reverse().forEach(h=>{
    const el = document.createElement('div'); el.className='card';
    el.innerHTML = `<div style="display:flex;justify-content:space-between">
      <div><div style="font-weight:700">${esc(h.nombre)} ‚Ä¢ ${esc(h.telefono)}</div><div class="muted">${esc(h.fecha)} ‚Ä¢ ${esc(h.hora)}</div><div style="margin-top:6px">${esc(h.detalleResumen || h.detalle)}</div></div>
      <div style="text-align:right">
        <div class="muted">Total: $${Number(h.total).toLocaleString('es-CO')}</div>
        <div style="margin-top:8px">
          ${h.estado!=='aprobado'? `<button data-apr="${h.timestamp}" class="small">Aprobar</button>` : ''}
          ${h.estado!=='entregado'? `<button data-ent="${h.timestamp}" class="small">Marcar entregado</button>` : ''}
          <button data-invoice="${h.timestamp}" class="small btn-ghost">Generar cuenta</button>
        </div>
      </div>
    </div>`;
    node.appendChild(el);
  });
  node.querySelectorAll('button[data-apr]').forEach(b=> b.addEventListener('click', async ()=>{ const ts=b.dataset.apr; if(!confirm('Aprobar pedido?')) return; const res=await getJSON(`${GOOGLE_SHEETS_API}?action=aprobarPedido&timestamp=${encodeURIComponent(ts)}`); if(res && res.success){ alert('Pedido aprobado'); await loadHistorial(); renderAdminPedidos(); } else alert('Error'); }));
  node.querySelectorAll('button[data-ent]').forEach(b=> b.addEventListener('click', async ()=>{ const ts=b.dataset.ent; if(!confirm('Marcar como entregado?')) return; const res=await getJSON(`${GOOGLE_SHEETS_API}?action=confirmarEntrega&timestamp=${encodeURIComponent(ts)}`); if(res && res.success){ alert('Registrado como entregado'); await loadHistorial(); renderAdminPedidos(); renderStats(); } else alert('Error'); }));
  node.querySelectorAll('button[data-invoice]').forEach(b=> b.addEventListener('click', async ()=>{ const ts=b.dataset.invoice; const res=await getJSON(`${GOOGLE_SHEETS_API}?action=generarCuentaCobro&timestamp=${encodeURIComponent(ts)}&enviarEmail=`); if(res && res.success) alert('Cuenta generada: '+(res.driveUrl||res.driveId)); else alert('Error'); }));
}

/* Facturaci√≥n admin */
$('#btnGenPdfMensual').addEventListener('click', async ()=>{ const mes = $('#factMes').value; if(!mes) return alert('Selecciona mes'); const res=await getJSON(`${GOOGLE_SHEETS_API}?action=generarCuentaCobroMensual&mes=${encodeURIComponent(mes)}`); if(res && res.success) alert('PDF generado: '+(res.driveUrl||res.driveId)); else alert('Error'); });
$('#btnGenExcelMensual').addEventListener('click', async ()=>{ const mes = $('#factMes').value; if(!mes) return alert('Selecciona mes'); const res=await getJSON(`${GOOGLE_SHEETS_API}?action=generarExcelDetallePorEmpleado&mes=${encodeURIComponent(mes)}`); if(res && res.success) alert('Excel: '+(res.driveUrl||res.driveId)); else alert('Error'); });
$('#btnGenInvoice').addEventListener('click', async ()=>{ const ts = $('#invoiceTimestamp').value.trim(); if(!ts) return alert('Ingresa timestamp'); const res = await getJSON(`${GOOGLE_SHEETS_API}?action=generarCuentaCobro&timestamp=${encodeURIComponent(ts)}&enviarEmail=`); if(res && res.success) alert('Cuenta generada: '+(res.driveUrl||res.driveId)); else alert('Error'); });

/* Promos admin */
$('#btnAddPromo').addEventListener('click', async ()=>{
  const nombre = $('#promoNombre').value.trim(), filtro = $('#promoFiltro').value.trim(), mult = parseFloat($('#promoMult').value.trim());
  if(!nombre || !filtro || isNaN(mult)) return alert('Completa datos');
  const res = await getJSON(`${GOOGLE_SHEETS_API}?action=agregarPromo&nombre=${encodeURIComponent(nombre)}&filtro=${encodeURIComponent(filtro)}&mult=${encodeURIComponent(mult)}`);
  if(res && res.success){ $('#promoNombre').value=''; $('#promoFiltro').value=''; $('#promoMult').value=''; await loadPromos(); renderPromos(); } else alert('Error');
});
async function renderPromos(){ await loadPromos(); const node = $('#promosList'); node.innerHTML = ''; if(!promos.length) { node.innerHTML='<div class="muted">No hay promos</div>'; return; } promos.forEach(p=>{ const el=document.createElement('div'); el.className='card'; el.innerHTML=`<div style="display:flex;justify-content:space-between"><div><div style="font-weight:700">${esc(p.nombre)}</div><div class="muted">Filtro: ${esc(p.filtro)} ‚Ä¢ x${esc(p.mult)}</div></div><div><button data-delpromo="${p.id}" class="btn-ghost small">Eliminar</button></div></div>`; node.appendChild(el); }); node.querySelectorAll('button[data-delpromo]').forEach(b=> b.addEventListener('click', async ()=>{ if(!confirm('Eliminar promo?')) return; const id=b.dataset.delpromo; const res=await getJSON(`${GOOGLE_SHEETS_API}?action=eliminarPromo&id=${encodeURIComponent(id)}`); if(res && res.success) await loadPromos(), renderPromos(); else alert('Error'); })); }

/* Configuraci√≥n */
$('#btnGuardarCfg').addEventListener('click', async ()=>{
  const numero = $('#cfgNumeroWimpy').value.trim(), nombre = $('#cfgNombreW').value.trim(), nit = $('#cfgNIT').value.trim();
  const empNombre = $('#cfgEmpresaNombre').value.trim(), empNit = $('#cfgEmpresaNIT').value.trim(), empCodigo = $('#cfgCodigoEmpresa').value.trim();
  const data = { numero: numero, nombre:nombre, nit:nit, empresaNombre: empNombre, empresaNit: empNit, empresaCodigo: empCodigo };
  const res = await getJSON(`${GOOGLE_SHEETS_API}?action=guardarWimpy&data=${encodeURIComponent(JSON.stringify(data))}`);
  if(res && res.success) alert('Guardado'); else alert('Error');
});
$('#btnCargarCfg').addEventListener('click', loadConfig);
async function loadConfig(){
  const r = await getJSON(`${GOOGLE_SHEETS_API}?action=obtenerConfiguracion`);
  if(r && r.success){
    $('#cfgNumeroWimpy').value = r.numero || '';
    $('#cfgNombreW').value = (r.wimpy && r.wimpy.nombre) || '';
    $('#cfgNIT').value = (r.wimpy && r.wimpy.nit) || '';
    $('#cfgEmpresaNombre').value = (r.empresa && r.empresa.nombre) || '';
    $('#cfgEmpresaNIT').value = (r.empresa && r.empresa.nit) || '';
    $('#cfgCodigoEmpresa').value = (r.empresa && r.empresa.codigo) || '';
    window.NUMERO_WIMPY = r.numero || NUMERO_WIMPY;
  } else alert('Error cargando configuraci√≥n');
}

/* Backups */
$('#btnBackupNow').addEventListener('click', async ()=>{ const res = await getJSON(`${GOOGLE_SHEETS_API}?action=backupDiario`); if(res && res.success) { $('#backupLog').textContent = 'Backup creado: '+(res.driveUrl||res.driveId); alert('Backup creado'); } else alert('Error'); });
$('#btnCrearTrigger').addEventListener('click', async ()=>{ const res = await getJSON(`${GOOGLE_SHEETS_API}?action=crearTriggerBackup`); if(res && res.success) alert('Trigger creado'); else alert('Error'); });

/* Stats */
function renderStats(){ $('#stat_total').textContent = historial.length; $('#stat_pend').textContent = historial.filter(h=>h.estado==='pendiente').length; $('#stat_ent').textContent = historial.filter(h=>h.estado==='entregado').length; getJSON(`${GOOGLE_SHEETS_API}?action=getTotalPuntos`).then(r=>{ $('#stat_pts').textContent = r && r.success ? (r.total||0) : 0; }); }

/* Init */
(async function init(){
  await loadProductos(); await loadClientes(); await loadHistorial(); await loadPromos();
  // render short initial data if needed
})();
</script>
</body>
</html>