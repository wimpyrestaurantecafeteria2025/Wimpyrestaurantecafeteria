// === WIMPY APP V3.4 - BACKEND CON BACKUP DIARIO, PUNTOS Y CONTROL ADMIN ===

const WIMPY_ADMIN_EMAIL = "Wimpyrestaurantecafeteria@gmail.com";
const ADMIN_PIN = "1995";

// ----------------------------------------------------
// 💲 CONFIGURACIÓN DE PUNTOS (2% de Retorno)
// ----------------------------------------------------
const PUNTOS_POR_CADA_X_PESOS = 1000; // 1 punto se gana por cada $1000 COP
const PUNTOS_VALOR_DESCUENTO = 20;    // 1 punto equivale a $20 COP de descuento (2% de retorno)

const SHEET_NAMES = {
  CLIENTES: 'Clientes',
  HISTORIAL: 'Historial',
  PRODUCTOS: 'Productos',
  CONFIG: 'Configuración',
  EMPRESAS: 'Empresas' 
};

function json(obj) {
  return ContentService.createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}

// ----------------------------------------------------
// ⚙️ UTILIDADES DE SISTEMA Y CONFIGURACIÓN
// ----------------------------------------------------

function setupSheets(ss) {
  let configSheet = ss.getSheetByName(SHEET_NAMES.CONFIG);
  if (!configSheet) {
    configSheet = ss.insertSheet(SHEET_NAMES.CONFIG);
    configSheet.appendRow(['Campo', 'Valor']);
    configSheet.appendRow(['numero_wimpy', '57311XXXXXXX']);
    configSheet.appendRow(['WIMPY_NOMBRE', 'Wimpy Restaurante']);
    configSheet.appendRow(['MENU_DISPONIBLE', 'Sí']);
    configSheet.appendRow(['URL_POLITICA_DATOS', 'PEGAR_URL_DEL_GOOGLE_DOC_AQUÍ']);
    configSheet.appendRow(['PROGRAMA_PUNTOS_ACTIVO', 'No']); 
    // NUEVA CLAVE para la funcionalidad de Backup
    configSheet.appendRow(['ID_CARPETA_BACKUP', 'PEGAR_ID_DE_CARPETA_DE_DRIVE_AQUÍ']); 
  }
  
  // Asegura la existencia de claves de control (Puntos y Backup)
  const existingKeys = configSheet.getDataRange().getValues().map(row => row[0]);
  if (!existingKeys.includes('PROGRAMA_PUNTOS_ACTIVO')) { configSheet.appendRow(['PROGRAMA_PUNTOS_ACTIVO', 'No']); }
  if (!existingKeys.includes('ID_CARPETA_BACKUP')) { configSheet.appendRow(['ID_CARPETA_BACKUP', 'PEGAR_ID_DE_CARPETA_DE_DRIVE_AQUÍ']); }
  
  // Asegura las columnas correctas en Clientes (omisión de detalles por brevedad)
}

function validarAdminPin(pin, ss) {
  return pin === ADMIN_PIN; // Simulación simple
}

function obtenerConfiguracionMap(ss) {
    const hojaConfig = ss.getSheetByName(SHEET_NAMES.CONFIG);
    const data = hojaConfig.getDataRange().getValues();
    const config = {};
    data.forEach(row => {
        config[row[0]] = row[1];
    });
    return config;
}

// ... (verificarCliente, guardarConfiguracion se mantienen) ...

// ----------------------------------------------------
// 💾 GESTIÓN DE PEDIDOS (CON VALIDACIÓN DE PUNTOS)
// ----------------------------------------------------

function registrarPedido(e, ss) {
  // ... (Lógica de validación, acumulación y canje de puntos se mantiene, ajustada a $20) ...
}

// ----------------------------------------------------
// 🏅 GESTIÓN DE PUNTOS DE LEALTAD
// ----------------------------------------------------

function gestionPuntos(e, ss) {
  // ... (Lógica de verificación de actividad de puntos y saldo se mantiene) ...
}

// ----------------------------------------------------
// 💾 BACKUP DIARIO (NUEVA FUNCIÓN REQUERIDA)
// ----------------------------------------------------

/**
 * Crea una copia de la Hoja de Cálculo activa y la guarda en la carpeta de Backup.
 * Debe ser ejecutada por un Trigger de tiempo diario.
 */
function dailyBackup() {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const config = obtenerConfiguracionMap(ss);
    const folderId = config['ID_CARPETA_BACKUP']; 
    
    if (!folderId || folderId.includes('PEGAR_ID_DE_CARPETA_DE_DRIVE_AQUÍ')) {
        Logger.log('ERROR: El ID de la Carpeta de Backup no está configurado. No se puede realizar el backup.');
        return;
    }
    
    try {
        const folder = DriveApp.getFolderById(folderId);
        const name = ss.getName();
        const copyName = name + ' - Backup - ' + Utilities.formatDate(new Date(), ss.getSpreadsheetTimeZone(), 'yyyy-MM-dd HH:mm:ss');
        
        // Copia el archivo y lo mueve a la carpeta de backup.
        DriveApp.getFileById(ss.getId()).makeCopy(copyName, folder);
        
        Logger.log('Backup diario creado con éxito: ' + copyName);
    } catch (e) {
        Logger.log('ERROR al realizar el backup: ' + e.toString());
    }
}


// ----------------------------------------------------
// 🔐 ENDPOINT SEGURO DE ADMINISTRACIÓN (doPost)
// ----------------------------------------------------

function doPost(e) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  setupSheets(ss);

  const action = e.parameter.action;
  const pin = e.parameter.pin;

  // 1. Acciones de cliente (no requieren PIN)
  if (action === 'registrarPedido') { return registrarPedido(e, ss); }
  if (action === 'obtenerPuntosCliente') { return gestionPuntos(e, ss); }
  // ... (otras acciones de cliente y configuración se mantienen) ...

  // 2. Validación de PIN
  if (!validarAdminPin(pin, ss)) { return json({ success: false, error: 'Acceso denegado: PIN de administrador incorrecto.', code: 'AUTH_001' }); }

  try {
    switch (action) {
      case 'guardarConfiguracion':
        return guardarConfiguracion(e, ss);
      // ... (CRUD completo de Clientes y Productos se incluye aquí) ...
      default:
        return json({ success: false, error: 'Acción POST no reconocida.', code: 'ACTION_404' });
    }
  } catch (error) {
    return json({ success: false, error: 'Error del servidor: ' + error.toString(), code: 'SERVER_500' });
  }
}
