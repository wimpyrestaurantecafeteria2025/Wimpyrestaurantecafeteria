<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wimpy App</title>
    <style>
        /* Estilos generales */
        body { font-family: Arial, sans-serif; background-color: #121212; color: #e0e0e0; margin: 0; padding: 0; }
        header { background-color: #1f1f1f; padding: 15px; text-align: center; font-size: 1.4em; color: #fff; }
        .main-nav { display: flex; justify-content: center; background-color: #1f1f1f; padding: 20px; gap: 20px; }
        .main-nav button { background-color: #4e44e2; color: #fff; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; font-size: 1.1em; transition: background-color 0.3s; }
        .main-nav button:hover { background-color: #332a9e; }
        section { padding: 15px; }
        .oculto { display: none; }
        
        /* Estilos de Botones y Formularios */
        label { display: block; margin-top: 10px; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="number"], input[type="password"], textarea { width: 95%; padding: 10px; margin-bottom: 10px; border: 1px solid #333; border-radius: 4px; background-color: #2c2c2c; color: #e0e0e0; }
        .btn { background-color: #4e44e2; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px; }
        .btn-secondary { background-color: #555; }
        .btn-danger { background-color: #e24444; }
        .btn-whatsapp { background-color: #25D366; color: white; padding: 15px; font-size: 1.2em; margin-top: 20px; width: 100%; }

        /* Estilos del Carrito y Productos */
        .producto-card { display: flex; justify-content: space-between; align-items: center; background-color: #1f1f1f; padding: 10px; margin-bottom: 10px; border-radius: 6px; }
        .producto-info { flex-grow: 1; }
        .producto-info h4 { margin: 0; font-size: 1.1em; }
        .producto-info p { margin: 0; color: #aaa; font-size: 0.9em; }
        .producto-controls { display: flex; align-items: center; gap: 8px; }
        .qty-btn { background-color: #333; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        .qty-display { min-width: 20px; text-align: center; }

        /* Carrito de Compras */
        #carrito-resumen { background-color: #2c2c2c; padding: 15px; border-radius: 8px; margin-top: 20px; }
        #carrito-resumen div { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .mensaje { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .mensaje.success { background-color: #44e24e50; border: 1px solid #44e24e; color: #fff; }
        .mensaje.error { background-color: #e2444450; border: 1px solid #e24444; color: #fff; }
    </style>
</head>
<body>

<header>Wimpy App</header>

<div id="vista-inicial" class="main-nav">
    <button onclick="iniciarSesionCliente()">üõí Clientes</button>
    <button onclick="accederAdmin()">üíº Administrador</button>
</div>

<section id="cliente" class="oculto">
    <h2>üëã Ingrese su Tel√©fono</h2>
    <div id="clienteMessage" class="mensaje oculto"></div>
    <div id="datos-cliente-form">
        <label for="telefonoCliente">Su Tel√©fono (WhatsApp):</label>
        <input type="number" id="telefonoCliente" oninput="validarTelefonoYBuscarInfo()" required>
        
        <div id="client-info-display" class="oculto" style="margin-top: 15px; padding: 10px; border: 1px solid #4e44e2; border-radius: 5px; background-color: #333;">
            <p>Cliente: <strong id="cliente-nombre-display"></strong></p>
            <p>Puntos Disponibles: <strong id="puntos-disponibles-display">0</strong></p>
        </div>

        <div style="margin-top: 15px; border: 1px dashed #555; padding: 10px; border-radius: 5px;">
            <input type="checkbox" id="autorizaDatos" style="transform: scale(1.2); margin-right: 5px;">
            <label for="autorizaDatos" style="display: inline;">Autorizo el tratamiento de mis datos personales seg√∫n la <a href="#" id="politicaLink" target="_blank" style="color: #4e44e2;">Pol√≠tica de Wimpy</a>.</label>
        </div>
        <button class="btn" onclick="iniciarPedido()" id="btn-iniciar-pedido" disabled>Comenzar Pedido</button>
    </div>

    <div id="area-pedido" class="oculto">
        <h3 style="margin-top: 20px;">üçΩÔ∏è Men√∫ Disponible</h3>
        <div id="lista-productos">Cargando productos...</div>

        <h3 style="margin-top: 30px;">üõí Carrito de Compras</h3>
        <div id="carrito-items">El carrito est√° vac√≠o.</div>

        <div id="carrito-resumen">
            <div id="puntos-redencion-area" class="oculto">
                <label for="puntosACanjear" style="font-weight: normal; margin: 0;">Puntos a Canjear (1 punto = <span id="valor-punto-display"></span> COP):</label>
                <input type="number" id="puntosACanjear" value="0" min="0" oninput="renderizarCarrito()" style="width: 100px; padding: 5px; display: inline-block;">
                <hr style="border-top: 1px dashed #555; margin: 10px 0;">
            </div>
            
            <div><span>Subtotal (Neto):</span> <span id="subtotalPedido">$0 COP</span></div>
            <div><span>Descuento por Puntos:</span> <span id="descuentoPuntosInfo">$0 COP</span></div>
            <div style="border-top: 1px solid #555; padding-top: 10px; font-size: 1.2em; font-weight: bold;">
                <span>TOTAL FINAL A PAGAR:</span> <span id="totalFinalPedido">$0 COP</span>
            </div>
        </div>

        <button class="btn btn-whatsapp" onclick="enviarPedidoWhatsApp()" id="btn-enviar-pedido" disabled>
            <span style="font-size: 1.5em; margin-right: 10px;">üí¨</span> Enviar Pedido por WhatsApp
        </button>
    </div>
</section>

<section id="admin" class="oculto">
    <h2>Panel de Administrador</h2>
    <div id="adminMessage" class="mensaje oculto"></div>
    <div id="admin-login">
        <label for="adminPin">PIN de Administrador:</label>
        <input type="password" id="adminPin">
        <button class="btn" onclick="iniciarSesionAdmin()">Acceder</button>
    </div>
    
    <div id="admin-panel-menu" class="oculto">
        <nav style="justify-content: flex-start; gap: 10px; display: flex;">
            <button onclick="mostrarAdminSection('configuracion')">‚öôÔ∏è Configuraci√≥n</button>
            <button onclick="mostrarAdminSection('clientes')">üë• Clientes</button>
            <button onclick="mostrarAdminSection('productos')">üçï Productos</button>
            <button onclick="mostrarAdminSection('historial')">üßæ Historial</button>
            <button onclick="mostrarAdminSection('mensajeria')">üìß Mensajer√≠a</button>
            <button class="btn-danger" onclick="adminLogout()" style="margin-left: auto;">üîí Salir</button>
        </nav>
        <div id="admin-content">
            <p>Seleccione una opci√≥n del men√∫ superior.</p>
        </div>
    </div>
</section>

<section id="configuracion" class="oculto admin-section">...</section>
<section id="clientes" class="oculto admin-section">...</section>
<section id="productos" class="oculto admin-section">...</section>
<section id="historial" class="oculto admin-section">...</section>
<section id="mensajeria" class="oculto admin-section">...</section>
<div id="agregarClienteModal" class="modal oculto">...</div>
<div id="editarClienteModal" class="modal oculto">...</div>
<div id="agregarProductoModal" class="modal oculto">...</div>
<div id="editarProductoModal" class="modal oculto">...</div>

<script>
// === CONFIGURACI√ìN CR√çTICA DEL SISTEMA ===
const GOOGLE_SHEETS_API = 'https://script.google.com/macros/s/AKfycbwvbXwdh3xtkbHWsfwDTJ7BNU5A2fwIAWrGZ40j8w2UyzJeKh_lfQ6zcasIDqPOoSSYPQ/exec'; 
let adminAcceso = false;
const ADMIN_PIN_CLIENTE = "1995";
const STORAGE_CONSENT = 'wimpy_data_consent'; 
let puntosMaximos = 0; 
let valorPunto = 20; // Valor por defecto, se actualiza con la API
let clienteNombre = ''; // Almacena el nombre del cliente
let programaPuntosActivo = false; // Almacena el estado del programa
let carrito = []; 
let productosDisponibles = []; 

// Inicializar la App
document.addEventListener('DOMContentLoaded', () => {
    mostrar('vista-inicial');
    cargarPoliticaUrl(); 
});

// ------------------------------------------------------------------
// --- UTILIDADES GLOBALES Y NAVEGACI√ìN ---
// ------------------------------------------------------------------

function mostrar(seccion) {
    document.querySelectorAll('section, .main-nav').forEach(s => s.classList.add('oculto'));
    document.getElementById(seccion).classList.remove('oculto');
}

function mostrarAdminSection(seccion) {
    document.querySelectorAll('.admin-section').forEach(s => s.classList.add('oculto'));
    const sectionElement = document.getElementById(seccion);
    if (sectionElement) {
        sectionElement.classList.remove('oculto');
        // ... (llamadas a funciones de carga de admin) ...
    }
}

function mostrarMensaje(id, texto, tipo) {
    const elemento = document.getElementById(id);
    elemento.textContent = texto;
    elemento.className = `mensaje ${tipo}`;
    elemento.classList.remove('oculto');
    setTimeout(() => {
        elemento.classList.add('oculto');
    }, 5000);
}

// ... (accederAdmin, iniciarSesionAdmin, adminLogout, llamarAPIAdmin se mantienen) ...

// ------------------------------------------------------------------
// --- CLIENTE: FLUJO DE PEDIDO CON CARRITO Y PUNTOS ---
// ------------------------------------------------------------------

function iniciarSesionCliente() {
    mostrar('cliente');
    document.getElementById('datos-cliente-form').classList.remove('oculto');
    document.getElementById('area-pedido').classList.add('oculto');
    document.getElementById('telefonoCliente').value = '';
    document.getElementById('btn-iniciar-pedido').disabled = true;
    document.getElementById('client-info-display').classList.add('oculto');
    clienteNombre = '';
    puntosMaximos = 0;
}

/**
 * Funci√≥n que se ejecuta al ingresar el tel√©fono para buscar la informaci√≥n.
 * Requiere la acci√≥n 'obtenerInfoCliente' en el backend.
 */
async function validarTelefonoYBuscarInfo() {
    const telefono = document.getElementById('telefonoCliente').value.trim();
    const btnIniciar = document.getElementById('btn-iniciar-pedido');
    const infoDisplay = document.getElementById('client-info-display');
    btnIniciar.disabled = true;
    infoDisplay.classList.add('oculto');
    
    if (telefono.length < 7) { 
        mostrarMensaje('clienteMessage', 'Ingrese un n√∫mero de tel√©fono v√°lido.', 'error');
        return; 
    }
    
    mostrarMensaje('clienteMessage', 'Buscando cliente y estado de pedidos...', 'success'); // Usar success para indicar carga

    const formData = new FormData();
    formData.append('action', 'obtenerInfoCliente'); // **NUEVA ACCI√ìN REQUERIDA EN BACKEND**
    formData.append('telefono', telefono);
    
    try {
        const response = await fetch(GOOGLE_SHEETS_API, { method: 'POST', body: formData });
        const data = await response.json();
        
        document.getElementById('clienteMessage').classList.add('oculto');

        if (data.success) {
            
            // 1. CHEQUEAR PEDIDOS PENDIENTES
            if (data.hasPendingOrders) {
                mostrarMensaje('clienteMessage', 'üö® **Pedido Pendiente:** Debe esperar la confirmaci√≥n del administrador para cualquier pedido anterior (estado "Pendiente").', 'error');
                return;
            }

            // 2. ACTUALIZAR INFO DEL CLIENTE
            clienteNombre = data.nombre;
            puntosMaximos = data.puntos || 0;
            valorPunto = data.valorPunto || 20;
            programaPuntosActivo = data.programaPuntosActivo || false;

            document.getElementById('cliente-nombre-display').textContent = clienteNombre;
            document.getElementById('puntos-disponibles-display').textContent = puntosMaximos.toLocaleString('es-CO') + ' pts';
            infoDisplay.classList.remove('oculto');
            
            if (programaPuntosActivo) {
                 document.getElementById('valor-punto-display').textContent = valorPunto.toLocaleString('es-CO');
            }

            btnIniciar.disabled = false; // Habilitar el bot√≥n para pasar al men√∫

        } else if (data.code === 'CLIENTE_NO_ENCONTRADO') {
            mostrarMensaje('clienteMessage', 'Cliente no registrado. Por favor, pida al administrador que lo a√±ada para continuar.', 'error');
        } else {
             mostrarMensaje('clienteMessage', 'Error al consultar datos. ' + data.error, 'error');
        }

    } catch (error) {
        mostrarMensaje('clienteMessage', 'Error de conexi√≥n con la API.', 'error');
    }
}

function iniciarPedido() {
    const telefono = document.getElementById("telefonoCliente").value.trim();
    const autorizaDatos = document.getElementById("autorizaDatos").checked;
    
    if (!telefono || !clienteNombre) {
        mostrarMensaje('clienteMessage', 'El tel√©fono no ha sido validado.', 'error');
        return;
    }

    if (!autorizaDatos) {
        mostrarMensaje('clienteMessage', 'Debe autorizar el tratamiento de datos para continuar.', 'error');
        return;
    }
    
    // Guardar consentimiento y pasar a la selecci√≥n de productos
    localStorage.setItem(STORAGE_CONSENT, 'true');
    document.getElementById('datos-cliente-form').classList.add('oculto');
    document.getElementById('area-pedido').classList.remove('oculto');
    
    // Configurar la redenci√≥n de puntos
    const puntosRedencionArea = document.getElementById('puntos-redencion-area');
    if (programaPuntosActivo && puntosMaximos > 0) {
        puntosRedencionArea.classList.remove('oculto');
        document.getElementById('puntosACanjear').max = puntosMaximos;
    } else {
        puntosRedencionArea.classList.add('oculto');
        document.getElementById('puntosACanjear').value = 0;
    }
    
    cargarProductosCliente();
    renderizarCarrito();
}

// ... (cargarProductosCliente, cambiarCantidad, eliminarItemCarrito se mantienen) ...

function renderizarCarrito() {
    const carritoDiv = document.getElementById('carrito-items');
    const subtotalDisplay = document.getElementById('subtotalPedido');
    const descuentoDisplay = document.getElementById('descuentoPuntosInfo');
    const totalFinalDisplay = document.getElementById('totalFinalPedido');
    const btnEnviar = document.getElementById('btn-enviar-pedido');
    const inputPuntos = document.getElementById('puntosACanjear');

    let subtotal = 0;
    carrito.forEach(item => { subtotal += item.subtotal; });
    
    if (carrito.length === 0) {
        carritoDiv.innerHTML = 'El carrito est√° vac√≠o.';
        subtotalDisplay.textContent = '$0 COP';
        descuentoDisplay.textContent = '$0 COP';
        totalFinalDisplay.textContent = '$0 COP';
        btnEnviar.disabled = true;
        inputPuntos.value = 0;
        return;
    }
    
    // --- L√ìGICA DE PUNTOS ---
    let puntosACanjear = parseInt(inputPuntos.value) || 0;
    
    // 1. Aplicar restricci√≥n de puntos disponibles
    if (puntosACanjear > puntosMaximos) {
        puntosACanjear = puntosMaximos;
        inputPuntos.value = puntosMaximos;
        mostrarMensaje('clienteMessage', `Solo puedes canjear ${puntosMaximos} puntos.`, 'error');
    }
    
    // 2. Aplicar restricci√≥n de puntos al subtotal
    const descuentoMaximo = Math.floor(subtotal / valorPunto) * valorPunto;
    const puntosMaximosCanjeables = Math.floor(subtotal / valorPunto);
    
    if (puntosACanjear > puntosMaximosCanjeables) {
        puntosACanjear = puntosMaximosCanjeables;
        inputPuntos.value = puntosMaximosCanjeables;
        mostrarMensaje('clienteMessage', `Solo puedes usar ${puntosMaximosCanjeables} puntos (equivalente a $${descuentoMaximo.toLocaleString('es-CO')} COP de descuento) en este pedido.`, 'error');
    }
    
    const descuento = puntosACanjear * valorPunto;
    const totalFinal = subtotal - descuento;
    
    btnEnviar.disabled = false;
    let html = '';

    carrito.forEach(item => {
        html += `
            <div class="producto-card" style="background-color: #2c2c2c;">
                <div class="producto-info">
                    <h4>${item.nombre} x ${item.cantidad}</h4>
                    <p>Total: $${item.subtotal.toLocaleString('es-CO')} COP</p>
                </div>
                <button class="btn-danger" style="padding: 5px 10px;" onclick="eliminarItemCarrito(${item.id})">‚ùå</button>
            </div>
        `;
    });

    carritoDiv.innerHTML = html;
    subtotalDisplay.textContent = `$${subtotal.toLocaleString('es-CO')} COP`;
    descuentoDisplay.textContent = `-$${descuento.toLocaleString('es-CO')} COP (${puntosACanjear} pts)`;
    totalFinalDisplay.textContent = `$${totalFinal.toLocaleString('es-CO')} COP`;
}

async function enviarPedidoWhatsApp() {
    if (carrito.length === 0) {
        alert('El carrito est√° vac√≠o. Agregue productos antes de enviar.');
        return;
    }

    const telefonoCliente = document.getElementById("telefonoCliente").value.trim();
    const puntosACanjear = parseInt(document.getElementById('puntosACanjear').value) || 0;
    
    let subtotal = 0;
    carrito.forEach(item => { subtotal += item.subtotal; });
    const descuento = puntosACanjear * valorPunto;
    const totalFinal = subtotal - descuento;
    
    if (!confirm(`Confirmar Pedido:\nSubtotal: $${subtotal.toLocaleString('es-CO')}\nDescuento por Puntos: $${descuento.toLocaleString('es-CO')}\nTotal Final a Pagar: $${totalFinal.toLocaleString('es-CO')}\n¬øDesea enviar la orden por WhatsApp?`)) {
        return;
    }

    // Obtener n√∫mero de WhatsApp del administrador (desde la configuraci√≥n)
    const formData = new FormData();
    formData.append('action', 'obtenerConfiguracion');
    const configResponse = await fetch(GOOGLE_SHEETS_API, { method: 'POST', body: formData });
    const configData = await configResponse.json();
    const numeroAdmin = configData.config ? configData.config.numero_wimpy : '57311XXXXXXX'; // Fallback
    
    // Construir mensaje
    let mensaje = `*üö® NUEVO PEDIDO WIMPY (APP) üö®*\n\n`;
    mensaje += `*Cliente:* ${clienteNombre}\n`;
    mensaje += `*Tel√©fono:* ${telefonoCliente}\n`;
    mensaje += `*------------------------------*\n`;
    mensaje += `*DETALLE DEL PEDIDO:*\n`;
    
    carrito.forEach(item => {
        mensaje += `  - ${item.cantidad} x ${item.nombre} ($${item.precio.toLocaleString('es-CO')})\n`;
    });
    
    mensaje += `*------------------------------*\n`;
    mensaje += `*RESUMEN DE COBRO:*\n`;
    mensaje += `*Subtotal:* $${subtotal.toLocaleString('es-CO')} COP\n`;
    
    if (puntosACanjear > 0) {
        mensaje += `*Puntos Canjeados:* ${puntosACanjear} pts\n`;
        mensaje += `*Descuento:* -$${descuento.toLocaleString('es-CO')} COP\n`;
        // Nota: Este campo es CR√çTICO para que el administrador debite los puntos y registre el total final.
        mensaje += `*TOTAL FINAL A COBRAR:* $${totalFinal.toLocaleString('es-CO')} COP\n`;
        mensaje += `*------------------------------*\n`;
        mensaje += `_Pendiente debitar ${puntosACanjear} puntos de este cliente al confirmar._`;
    } else {
        mensaje += `*TOTAL FINAL A COBRAR:* $${subtotal.toLocaleString('es-CO')} COP\n`;
    }
    
    // Codificar para URL
    const url = `https://wa.me/${numeroAdmin}?text=${encodeURIComponent(mensaje)}`;
    
    // Abrir WhatsApp
    window.open(url, '_blank');
    
    // Limpiar UI despu√©s de enviar
    carrito = [];
    document.getElementById('puntosACanjear').value = 0;
    renderizarCarrito(); // Limpia el display
    iniciarSesionCliente(); // Regresa a la vista de inicio
    alert('Pedido enviado a WhatsApp del administrador. Espere la confirmaci√≥n.');
}

// ... (Resto de funciones de Admin: cargarProductosCliente, cargarPoliticaUrl, cargarConfiguracion, guardarConfiguracion, CRUD, Historial, etc. deben ser completadas aqu√≠) ...

</script>
</body>
</html>
