<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wimpy App</title>
    <style>
        /* Estilos generales */
        body { font-family: Arial, sans-serif; background-color: #121212; color: #e0e0e0; margin: 0; padding: 0; }
        header { background-color: #1f1f1f; padding: 15px; text-align: center; font-size: 1.4em; color: #fff; }
        .main-nav { display: flex; justify-content: center; background-color: #1f1f1f; padding: 20px; gap: 20px; }
        /* Botones de navegaci√≥n principal y men√∫ de cliente */
        .main-nav button, #menu-cliente button { 
            background-color: #4e44e2; 
            color: #fff; 
            border: none; 
            padding: 15px 30px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 1.1em; 
            transition: background-color 0.3s; 
            flex-grow: 1; /* Para que ocupen el mismo ancho */
        }
        .main-nav button:hover, #menu-cliente button:hover { background-color: #332a9e; }
        section { padding: 15px; }
        .oculto { display: none; }
        
        /* Estilos de Botones y Formularios */
        label { display: block; margin-top: 10px; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="number"], input[type="password"], textarea { width: 95%; padding: 10px; margin-bottom: 10px; border: 1px solid #333; border-radius: 4px; background-color: #2c2c2c; color: #e0e0e0; }
        .btn { background-color: #4e44e2; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px; }
        .btn-secondary { background-color: #555; }
        .btn-danger { background-color: #e24444; }
        .btn-whatsapp { background-color: #25D366; color: white; padding: 15px; font-size: 1.2em; margin-top: 20px; width: 100%; }

        /* Estilos del Carrito y Productos */
        .producto-card { display: flex; justify-content: space-between; align-items: center; background-color: #1f1f1f; padding: 10px; margin-bottom: 10px; border-radius: 6px; }
        .producto-info { flex-grow: 1; }
        .producto-info h4 { margin: 0; font-size: 1.1em; }
        .producto-info p { margin: 0; color: #aaa; font-size: 0.9em; }
        .producto-controls { display: flex; align-items: center; gap: 8px; }
        .qty-btn { background-color: #333; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        .qty-display { min-width: 20px; text-align: center; }

        /* Carrito de Compras */
        #carrito-resumen { background-color: #2c2c2c; padding: 15px; border-radius: 8px; margin-top: 20px; }
        #carrito-resumen div { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .mensaje { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .mensaje.success { background-color: #44e24e50; border: 1px solid #44e24e; color: #fff; }
        .mensaje.error { background-color: #e2444450; border: 1px solid #e24444; color: #fff; }
    </style>
</head>
<body>

<header>Wimpy App</header>

<div id="vista-inicial" class="main-nav">
    <button onclick="iniciarSesionCliente()">üõí Clientes</button>
    <button onclick="accederAdmin()">üíº Administrador</button>
</div>

<section id="cliente" class="oculto">
    
    <h2>üëã Ingrese su Tel√©fono</h2>
    <div id="clienteMessage" class="mensaje oculto"></div>
    <div id="datos-cliente-form">
        <label for="telefonoCliente">Su Tel√©fono (WhatsApp):</label>
        <input type="number" id="telefonoCliente" oninput="validarTelefonoYBuscarInfo()" required>
        
        <div id="client-info-display" class="oculto" style="margin-top: 15px; padding: 10px; border: 1px solid #4e44e2; border-radius: 5px; background-color: #333;">
            <p>Cliente: <strong id="cliente-nombre-display"></strong></p>
            <p>Puntos Disponibles: <strong id="puntos-disponibles-display">0</strong></p>
        </div>

        <div style="margin-top: 15px; border: 1px dashed #555; padding: 10px; border-radius: 5px;">
            <input type="checkbox" id="autorizaDatos" style="transform: scale(1.2); margin-right: 5px;">
            <label for="autorizaDatos" style="display: inline;">Autorizo el tratamiento de mis datos personales seg√∫n la <a href="#" id="politicaLink" target="_blank" style="color: #4e44e2;">Pol√≠tica de Wimpy</a>.</label>
        </div>
        <button class="btn" onclick="iniciarPedido()" id="btn-iniciar-pedido" disabled>Acceder al Men√∫</button>
        <button class="btn btn-secondary" onclick="iniciarSesionCliente()" style="width: 100%; margin-top: 15px;">‚¨ÖÔ∏è Regresar</button>
    </div>

    <div id="menu-cliente" class="oculto">
        <h2 style="text-align: center;">Bienvenido, <span id="cliente-nombre-menu">Cliente</span></h2>
        <div class="main-nav" style="flex-direction: column; padding: 10px 0;">
            <button onclick="mostrarAreaPedido()">üõí **Hacer Pedido**</button>
            <button onclick="mostrarConfirmacionRecibido()">‚úÖ **Confirmar Recibido de Pedidos**</button>
            <button class="btn-secondary" onclick="iniciarSesionCliente()" style="background-color: #333; margin-top: 20px; color: #ccc;">‚¨ÖÔ∏è Cambiar Cliente / Salir</button>
        </div>
    </div>

    <div id="area-pedido" class="oculto">
        <h3 style="margin-top: 20px;">üçΩÔ∏è Men√∫ Disponible</h3>
        <div id="lista-productos">Cargando productos...</div>

        <h3 style="margin-top: 30px;">üõí Carrito de Compras</h3>
        <div id="carrito-items">El carrito est√° vac√≠o.</div>

        <div id="carrito-resumen">
            <div id="puntos-redencion-area" class="oculto">
                <label for="puntosACanjear" style="font-weight: normal; margin: 0;">Puntos a Canjear (1 punto = <span id="valor-punto-display"></span> COP):</label>
                <input type="number" id="puntosACanjear" value="0" min="0" oninput="renderizarCarrito()" style="width: 100px; padding: 5px; display: inline-block;">
                <hr style="border-top: 1px dashed #555; margin: 10px 0;">
            </div>
            
            <div><span>Subtotal (Neto):</span> <span id="subtotalPedido">$0 COP</span></div>
            <div><span>Descuento por Puntos:</span> <span id="descuentoPuntosInfo">$0 COP</span></div>
            <div style="border-top: 1px solid #555; padding-top: 10px; font-size: 1.2em; font-weight: bold;">
                <span>TOTAL FINAL A PAGAR:</span> <span id="totalFinalPedido">$0 COP</span>
            </div>
        </div>

        <button class="btn btn-whatsapp" onclick="enviarPedidoWhatsApp()" id="btn-enviar-pedido" disabled>
            <span style="font-size: 1.5em; margin-right: 10px;">üí¨</span> Enviar Pedido por WhatsApp
        </button>
        <button class="btn btn-secondary" onclick="iniciarPedido()" style="width: 100%; margin-top: 15px;">‚¨ÖÔ∏è Volver al Men√∫ Principal</button>
    </div>

    <div id="area-confirmar-recibido" class="oculto">
        <h3 style="margin-top: 20px;">‚úÖ Pedidos por Confirmar Recibido</h3>
        <div id="lista-pedidos-recibir">Cargando pedidos pendientes...</div>
        <button class="btn btn-secondary" onclick="iniciarPedido()" style="width: 100%; margin-top: 15px;">‚¨ÖÔ∏è Volver al Men√∫ Principal</button>
    </div>

</section>

<section id="admin" class="oculto">...</section>
<section id="configuracion" class="oculto admin-section">...</section>
<section id="clientes" class="oculto admin-section">...</section>
<script>
// === CONFIGURACI√ìN CR√çTICA DEL SISTEMA ===
const GOOGLE_SHEETS_API = 'https://script.google.com/macros/s/AKfycbwvbXwdh3xtkbHWsfwDTJ7BNU5A2fwIAWrGZ40j8w2UyzJeKh_lfQ6zcasIDqPOoSSYPQ/exec'; 
let adminAcceso = false;
const ADMIN_PIN_CLIENTE = "1995";
const STORAGE_CONSENT = 'wimpy_data_consent'; 
let puntosMaximos = 0; 
let valorPunto = 20; 
let clienteNombre = ''; 
let programaPuntosActivo = false; 
let carrito = []; 
let productosDisponibles = []; 

// Inicializar la App
document.addEventListener('DOMContentLoaded', () => {
    mostrar('vista-inicial');
    // cargarPoliticaUrl(); // Debe estar implementada
});

// ------------------------------------------------------------------
// --- UTILIDADES GLOBALES Y NAVEGACI√ìN ---
// ------------------------------------------------------------------

function mostrar(seccion) {
    document.querySelectorAll('section, .main-nav').forEach(s => s.classList.add('oculto'));
    document.getElementById(seccion).classList.remove('oculto');
}

// ... (accederAdmin, iniciarSesionAdmin, adminLogout, llamarAPIAdmin, etc. se mantienen) ...

// ------------------------------------------------------------------
// --- CLIENTE: FLUJO DE PEDIDO CON MEN√ö (L√ìGICA ACTUALIZADA) ---
// ------------------------------------------------------------------

function iniciarSesionCliente() {
    mostrar('cliente');
    // Mostrar solo el formulario de ingreso de tel√©fono al inicio
    document.getElementById('datos-cliente-form').classList.remove('oculto');
    document.getElementById('menu-cliente').classList.add('oculto');
    document.getElementById('area-pedido').classList.add('oculto');
    document.getElementById('area-confirmar-recibido').classList.add('oculto');
    
    // Limpiar campos y banderas
    document.getElementById('telefonoCliente').value = '';
    document.getElementById('btn-iniciar-pedido').disabled = true;
    document.getElementById('client-info-display').classList.add('oculto');
    clienteNombre = '';
    puntosMaximos = 0;
}

/**
 * Funci√≥n que se ejecuta al ingresar el tel√©fono para buscar la informaci√≥n.
 */
async function validarTelefonoYBuscarInfo() {
    const telefono = document.getElementById('telefonoCliente').value.trim();
    const btnIniciar = document.getElementById('btn-iniciar-pedido');
    const infoDisplay = document.getElementById('client-info-display');
    btnIniciar.disabled = true;
    infoDisplay.classList.add('oculto');
    
    if (telefono.length < 7) { 
        document.getElementById('clienteMessage').classList.add('oculto');
        return; 
    }
    
    // Asumiendo que esta funci√≥n llama a 'obtenerInfoCliente' del backend
    // ... (L√≥gica de API para buscar cliente, puntos y pedidos pendientes) ...
    // Placeholder de L√≥gica:
    const data = { success: true, nombre: 'Empresa Demo', puntos: 1500, valorPunto: 20, programaPuntosActivo: true, hasPendingOrders: false };
    
    if (data.success) {
        document.getElementById('clienteMessage').classList.add('oculto');

        // 1. CHEQUEAR PEDIDOS PENDIENTES
        if (data.hasPendingOrders) {
            mostrarMensaje('clienteMessage', 'üö® **Pedido Pendiente:** Debe esperar la confirmaci√≥n del administrador para cualquier pedido anterior (estado "Pendiente").', 'error');
            return;
        }

        // 2. ACTUALIZAR INFO DEL CLIENTE
        clienteNombre = data.nombre;
        puntosMaximos = data.puntos || 0;
        valorPunto = data.valorPunto || 20;
        programaPuntosActivo = data.programaPuntosActivo || false;

        document.getElementById('cliente-nombre-display').textContent = clienteNombre;
        document.getElementById('puntos-disponibles-display').textContent = puntosMaximos.toLocaleString('es-CO') + ' pts';
        infoDisplay.classList.remove('oculto');
        
        if (programaPuntosActivo) {
             document.getElementById('valor-punto-display').textContent = valorPunto.toLocaleString('es-CO');
        }

        btnIniciar.disabled = false; 

    } else {
         mostrarMensaje('clienteMessage', 'Error al consultar datos o Cliente no encontrado.', 'error');
    }
}


/**
 * Transiciona del formulario de tel√©fono al nuevo Men√∫ Principal de Cliente.
 */
function iniciarPedido() {
    const telefono = document.getElementById("telefonoCliente").value.trim();
    const autorizaDatos = document.getElementById("autorizaDatos").checked;
    
    if (!telefono || !clienteNombre) {
        mostrarMensaje('clienteMessage', 'El tel√©fono no ha sido validado.', 'error');
        return;
    }

    if (!autorizaDatos) {
        mostrarMensaje('clienteMessage', 'Debe autorizar el tratamiento de datos para continuar.', 'error');
        return;
    }
    
    // 1. Ocultar formulario de acceso
    document.getElementById('datos-cliente-form').classList.add('oculto');
    
    // 2. Mostrar el men√∫ principal
    document.getElementById('menu-cliente').classList.remove('oculto');
    document.getElementById('cliente-nombre-menu').textContent = clienteNombre;
    
    // Ocultar √°reas de pedido y recibo
    document.getElementById('area-pedido').classList.add('oculto');
    document.getElementById('area-confirmar-recibido').classList.add('oculto');
    
    localStorage.setItem(STORAGE_CONSENT, 'true');
}

/**
 * Muestra el √°rea de hacer pedidos (carrito).
 */
function mostrarAreaPedido() {
    document.getElementById('menu-cliente').classList.add('oculto');
    document.getElementById('area-confirmar-recibido').classList.add('oculto');
    document.getElementById('area-pedido').classList.remove('oculto');

    // Cargar productos y configurar redenci√≥n de puntos
    cargarProductosCliente(); // Se debe asegurar que esta funci√≥n est√© completa
    renderizarCarrito();

    const puntosRedencionArea = document.getElementById('puntos-redencion-area');
    if (programaPuntosActivo && puntosMaximos > 0) {
        puntosRedencionArea.classList.remove('oculto');
        document.getElementById('puntosACanjear').max = puntosMaximos;
    } else {
        puntosRedencionArea.classList.add('oculto');
        document.getElementById('puntosACanjear').value = 0;
    }
}


/**
 * Muestra el √°rea para confirmar recibo de pedidos.
 * Requiere una nueva acci√≥n en el backend.
 */
async function mostrarConfirmacionRecibido() {
    document.getElementById('menu-cliente').classList.add('oculto');
    document.getElementById('area-pedido').classList.add('oculto');
    document.getElementById('area-confirmar-recibido').classList.remove('oculto');
    
    const telefono = document.getElementById("telefonoCliente").value.trim();
    const listaDiv = document.getElementById('lista-pedidos-recibir');
    listaDiv.innerHTML = 'Buscando pedidos confirmados y enviados...';

    const formData = new FormData();
    formData.append('action', 'obtenerPedidosParaConfirmar'); // **NUEVA ACCI√ìN REQUERIDA EN BACKEND**
    formData.append('telefono', telefono);

    try {
        const response = await fetch(GOOGLE_SHEETS_API, { method: 'POST', body: formData });
        const data = await response.json();
        
        if (data.success && data.pedidos.length > 0) {
            let html = '<p>Haga clic en "Confirmar Recibido" en el pedido que ya tiene en sus manos.</p>';
            
            data.pedidos.forEach(p => {
                 html += `
                    <div class="producto-card" style="flex-direction: column; align-items: flex-start; margin-bottom: 15px;">
                        <h4 style="color: #44e24e;">Pedido del ${p.fecha} - Estado: ${p.estado}</h4>
                        <p>${p.detalle}</p>
                        <p>Total: **$${p.total.toLocaleString('es-CO')} COP**</p>
                        <button class="btn btn-whatsapp" style="width: 100%; margin-top: 10px;" onclick="confirmarPedido(${p.id})">
                           ‚úÖ Confirmar Recibido
                        </button>
                    </div>
                `;
            });
            listaDiv.innerHTML = html;
        } else {
             listaDiv.innerHTML = 'No tiene pedidos con estado "Confirmado" o "Enviado" pendientes de recibir.';
        }
    } catch (error) {
         listaDiv.innerHTML = 'Error de conexi√≥n al buscar pedidos.';
    }
}

// ... (El resto de funciones como cargarProductosCliente, cambiarCantidad, renderizarCarrito, enviarPedidoWhatsApp, etc. se mantienen) ...

// **NUEVA FUNCI√ìN REQUERIDA PARA EL BOT√ìN DE CONFIRMACI√ìN**
function confirmarPedido(pedidoId) {
    // Aqu√≠ se llamar√≠a a una nueva acci√≥n en el backend: 'marcarPedidoComoRecibido'
    alert(`Pedido ${pedidoId} marcado como Recibido. (Funcionalidad pendiente de implementar en Backend).`);
    mostrarConfirmacionRecibido(); // Recarga la lista
}


// ... (El resto del c√≥digo de Administraci√≥n, aunque simplificado, se mantiene) ...

</script>
</body>
</html>
