<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wimpy App</title>
    <style>
        /* Estilos generales */
        body { font-family: Arial, sans-serif; background-color: #121212; color: #e0e0e0; margin: 0; padding: 0; }
        header { background-color: #1f1f1f; padding: 15px; text-align: center; font-size: 1.4em; color: #fff; }
        .main-nav { display: flex; justify-content: center; background-color: #1f1f1f; padding: 20px; gap: 20px; }
        .main-nav button { background-color: #4e44e2; color: #fff; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; font-size: 1.1em; transition: background-color 0.3s; }
        .main-nav button:hover { background-color: #332a9e; }
        section { padding: 15px; }
        .oculto { display: none; }
        
        /* Estilos de Botones y Formularios */
        label { display: block; margin-top: 10px; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="number"], textarea { width: 95%; padding: 10px; margin-bottom: 10px; border: 1px solid #333; border-radius: 4px; background-color: #2c2c2c; color: #e0e0e0; }
        .btn { background-color: #4e44e2; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px; }
        .btn-secondary { background-color: #555; }
        .btn-danger { background-color: #e24444; }
        .btn-whatsapp { background-color: #25D366; color: white; padding: 15px; font-size: 1.2em; margin-top: 20px; width: 100%; }

        /* Estilos del Carrito y Productos */
        .producto-card { display: flex; justify-content: space-between; align-items: center; background-color: #1f1f1f; padding: 10px; margin-bottom: 10px; border-radius: 6px; }
        .producto-info { flex-grow: 1; }
        .producto-info h4 { margin: 0; font-size: 1.1em; }
        .producto-info p { margin: 0; color: #aaa; font-size: 0.9em; }
        .producto-controls { display: flex; align-items: center; gap: 8px; }
        .qty-btn { background-color: #333; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        .qty-display { min-width: 20px; text-align: center; }

        /* Carrito de Compras */
        #carrito-resumen { background-color: #2c2c2c; padding: 15px; border-radius: 8px; margin-top: 20px; }
        #carrito-resumen div { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .mensaje { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .mensaje.success { background-color: #44e24e50; border: 1px solid #44e24e; color: #fff; }
        .mensaje.error { background-color: #e2444450; border: 1px solid #e24444; color: #fff; }

        /* Otros */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #333; font-size: 0.9em; }
        th { background-color: #2c2c2c; }
    </style>
</head>
<body>

<header>Wimpy App</header>

<div id="vista-inicial" class="main-nav">
    <button onclick="iniciarSesionCliente()">üõí Cliente (Hacer Pedido)</button>
    <button onclick="accederAdmin()">üíº Administrador</button>
</div>

<section id="cliente" class="oculto">
    <h2>üëã Hola, Cliente. Ingresa tus datos para empezar</h2>
    <div id="clienteMessage" class="mensaje oculto"></div>
    <div id="datos-cliente-form">
        <label for="nombreCliente">Tu Nombre:</label>
        <input type="text" id="nombreCliente" required>
        <label for="telefonoCliente">Tu Tel√©fono (WhatsApp):</label>
        <input type="number" id="telefonoCliente" required>
        <div style="margin-top: 15px; border: 1px dashed #555; padding: 10px; border-radius: 5px;">
            <input type="checkbox" id="autorizaDatos" style="transform: scale(1.2); margin-right: 5px;">
            <label for="autorizaDatos" style="display: inline;">Autorizo el tratamiento de mis datos personales seg√∫n la <a href="#" id="politicaLink" target="_blank" style="color: #4e44e2;">Pol√≠tica de Wimpy</a>.</label>
        </div>
        <button class="btn" onclick="iniciarPedido()">Comenzar Pedido</button>
    </div>

    <div id="area-pedido" class="oculto">
        <h3 style="margin-top: 20px;">üçΩÔ∏è Men√∫ Disponible</h3>
        <div id="lista-productos">Cargando productos...</div>

        <h3 style="margin-top: 30px;">üõí Carrito de Compras</h3>
        <div id="carrito-items">El carrito est√° vac√≠o.</div>

        <div id="carrito-resumen">
            <div><span>Subtotal:</span> <span id="subtotalPedido">$0 COP</span></div>
            <div><span>Puntos Canjeados:</span> <span id="puntosCanjeadosInfo">0 puntos</span></div>
            <div style="border-top: 1px solid #555; padding-top: 10px; font-size: 1.2em; font-weight: bold;">
                <span>TOTAL FINAL:</span> <span id="totalFinalPedido">$0 COP</span>
            </div>
        </div>

        <button class="btn btn-whatsapp" onclick="enviarPedidoWhatsApp()" id="btn-enviar-pedido">
            <span style="font-size: 1.5em; margin-right: 10px;">üí¨</span> Enviar Pedido por WhatsApp
        </button>
    </div>
</section>

<section id="admin" class="oculto">
    <h2>Panel de Administrador</h2>
    <div id="adminMessage" class="mensaje oculto"></div>
    <div id="admin-login">
        <label for="adminPin">PIN de Administrador:</label>
        <input type="password" id="adminPin">
        <button class="btn" onclick="iniciarSesionAdmin()">Acceder</button>
    </div>
    
    <div id="admin-panel-menu" class="oculto">
        <nav style="justify-content: flex-start; gap: 10px;">
            <button onclick="mostrarAdminSection('configuracion')">‚öôÔ∏è Configuraci√≥n</button>
            <button onclick="mostrarAdminSection('clientes')">üë• Clientes</button>
            <button onclick="mostrarAdminSection('productos')">üçï Productos</button>
            <button onclick="mostrarAdminSection('historial')">üßæ Historial</button>
            <button onclick="mostrarAdminSection('mensajeria')">üìß Mensajer√≠a</button>
            <button class="btn-danger" onclick="adminLogout()" style="margin-left: auto;">üîí Salir</button>
        </nav>
        <div id="admin-content">
            <p>Seleccione una opci√≥n del men√∫ superior.</p>
        </div>
    </div>
</section>

<script>
// === CONFIGURACI√ìN CR√çTICA DEL SISTEMA ===
// URL de Despliegue de tu Google Apps Script (API Backend)
const GOOGLE_SHEETS_API = 'https://script.google.com/macros/s/AKfycbwvbXwdh3xtkbHWsfwDTJ7BNU5A2fwIAWrGZ40j8w2UyzJeKh_lfQ6zcasIDqPOoSSYPQ/exec'; 
let adminAcceso = false;
const ADMIN_PIN_CLIENTE = "1995";
const STORAGE_CONSENT = 'wimpy_data_consent'; 
let puntosMaximos = 0; // Almacena el saldo de puntos disponible
let carrito = []; // NUEVO: Estructura del carrito de compras
let productosDisponibles = []; // NUEVO: Lista completa de productos

// Inicializar la App
document.addEventListener('DOMContentLoaded', () => {
    mostrar('vista-inicial');
    cargarPoliticaUrl(); 
});

// ------------------------------------------------------------------
// --- UTILIDADES GLOBALES Y NAVEGACI√ìN ---
// ------------------------------------------------------------------

function mostrar(seccion) {
    document.querySelectorAll('section, .main-nav').forEach(s => s.classList.add('oculto'));
    document.getElementById(seccion).classList.remove('oculto');
}

function mostrarAdminSection(seccion) {
    document.querySelectorAll('.admin-section').forEach(s => s.classList.add('oculto'));
    const sectionElement = document.getElementById(seccion);
    if (sectionElement) {
        sectionElement.classList.remove('oculto');
        if (seccion === 'clientes') cargarClientes();
        if (seccion === 'productos') cargarProductos();
        if (seccion === 'historial') cargarHistorial();
        if (seccion === 'configuracion') cargarConfiguracion();
    }
}

function mostrarMensaje(id, texto, tipo) {
    const elemento = document.getElementById(id);
    elemento.textContent = texto;
    elemento.className = `mensaje ${tipo}`;
    elemento.classList.remove('oculto');
    setTimeout(() => {
        elemento.classList.add('oculto');
    }, 5000);
}

function mostrarModal(id) {
    document.getElementById(id).classList.remove('oculto');
}

function cerrarModal(id) {
    document.getElementById(id).classList.add('oculto');
}

// ------------------------------------------------------------------
// --- ACCESO DE ADMINISTRADOR (SOLUCI√ìN CONFLICTO) ---
// ------------------------------------------------------------------

function accederAdmin() {
    mostrar('admin');
    document.getElementById('admin-panel-menu').classList.add('oculto');
    document.getElementById('admin-login').classList.remove('oculto');
    document.getElementById('adminPin').value = ''; 
    adminAcceso = false;
}

function iniciarSesionAdmin() {
    const pin = document.getElementById('adminPin').value.trim();
    if (pin === ADMIN_PIN_CLIENTE) {
        adminAcceso = true;
        document.getElementById('admin-login').classList.add('oculto');
        document.getElementById('admin-panel-menu').classList.remove('oculto');
        mostrarAdminSection('configuracion'); 
        mostrarMensaje('adminMessage', 'Acceso concedido ‚úÖ', 'success');
    } else {
        mostrarMensaje('adminMessage', 'PIN incorrecto ‚ùå', 'error');
        adminAcceso = false;
    }
}

function adminLogout() {
    adminAcceso = false;
    mostrar('vista-inicial');
    document.getElementById('admin-panel-menu').classList.add('oculto');
    document.getElementById('admin-login').classList.remove('oculto');
}

async function llamarAPIAdmin(action, params = {}) {
    if (!adminAcceso) {
        mostrarMensaje('adminMessage', 'Acceso denegado. PIN incorrecto.', 'error');
        return { success: false, error: 'Acceso denegado' };
    }
    const formData = new FormData();
    formData.append('action', action);
    formData.append('pin', ADMIN_PIN_CLIENTE); 
    
    for (const key in params) {
        formData.append(key, params[key]);
    }

    try {
        const response = await fetch(GOOGLE_SHEETS_API, { method: 'POST', body: formData });
        const data = await response.json();
        return data;
    } catch (error) {
        mostrarMensaje('adminMessage', 'Error de conexi√≥n con la API.', 'error');
        console.error('API Error:', error);
        return { success: false, error: 'Error de conexi√≥n' };
    }
}

// ------------------------------------------------------------------
// --- CLIENTE: FLUJO DE PEDIDO CON CARRITO (NUEVA L√ìGICA) ---
// ------------------------------------------------------------------

function iniciarSesionCliente() {
    mostrar('cliente');
    document.getElementById('datos-cliente-form').classList.remove('oculto');
    document.getElementById('area-pedido').classList.add('oculto');
}

async function iniciarPedido() {
    const nombre = document.getElementById("nombreCliente").value.trim();
    const telefono = document.getElementById("telefonoCliente").value.trim();
    const autorizaDatos = document.getElementById("autorizaDatos").checked;

    if (!nombre || !telefono) {
        mostrarMensaje('clienteMessage', 'Por favor, ingrese su nombre y tel√©fono.', 'error');
        return;
    }
    if (!autorizaDatos) {
        mostrarMensaje('clienteMessage', 'Debe autorizar el tratamiento de datos para continuar.', 'error');
        return;
    }

    // Guardar consentimiento y pasar a la selecci√≥n de productos
    localStorage.setItem(STORAGE_CONSENT, 'true');
    document.getElementById('datos-cliente-form').classList.add('oculto');
    document.getElementById('area-pedido').classList.remove('oculto');
    
    await cargarProductosCliente();
    renderizarCarrito();
    // buscarPuntosCliente(); // Se puede reintegrar aqu√≠ si se usa el programa de puntos
}

async function cargarProductosCliente() {
    const listaDiv = document.getElementById('lista-productos');
    listaDiv.innerHTML = 'Cargando men√∫...';
    
    const formData = new FormData();
    formData.append('action', 'obtenerProductos');

    try {
        const response = await fetch(GOOGLE_SHEETS_API, { method: 'POST', body: formData });
        const data = await response.json();
        
        if (data.success && data.productos) {
            productosDisponibles = data.productos.filter(p => p.activo);
            let html = '';
            productosDisponibles.forEach(p => {
                html += `
                    <div class="producto-card" id="prod-${p.id}">
                        <div class="producto-info">
                            <h4>${p.nombre}</h4>
                            <p>$${p.precio.toLocaleString('es-CO')} COP</p>
                        </div>
                        <div class="producto-controls">
                            <button class="qty-btn" onclick="cambiarCantidad(${p.id}, -1)">-</button>
                            <span class="qty-display" id="qty-${p.id}">0</span>
                            <button class="qty-btn" onclick="cambiarCantidad(${p.id}, 1)">+</button>
                        </div>
                    </div>
                `;
            });
            listaDiv.innerHTML = html;
        } else {
            listaDiv.innerHTML = 'No hay productos disponibles o el men√∫ est√° inactivo.';
        }
    } catch (error) {
        listaDiv.innerHTML = 'Error al conectar con el servidor. Intente de nuevo m√°s tarde.';
    }
}

function cambiarCantidad(productoId, cambio) {
    const producto = productosDisponibles.find(p => p.id === productoId);
    if (!producto) return;

    const carritoItem = carrito.find(item => item.id === productoId);
    let nuevaCantidad = (carritoItem ? carritoItem.cantidad : 0) + cambio;

    if (nuevaCantidad < 0) nuevaCantidad = 0;
    
    // Actualizar la vista de cantidad en la lista de productos
    const qtyDisplay = document.getElementById(`qty-${productoId}`);
    if (qtyDisplay) qtyDisplay.textContent = nuevaCantidad;

    if (nuevaCantidad === 0) {
        carrito = carrito.filter(item => item.id !== productoId); // Eliminar del carrito
    } else if (carritoItem) {
        carritoItem.cantidad = nuevaCantidad; // Actualizar cantidad
        carritoItem.subtotal = nuevaCantidad * producto.precio;
    } else {
        // Agregar nuevo item
        carrito.push({
            id: productoId,
            nombre: producto.nombre,
            precio: producto.precio,
            cantidad: nuevaCantidad,
            subtotal: nuevaCantidad * producto.precio
        });
    }

    renderizarCarrito();
}

function eliminarItemCarrito(productoId) {
    const item = carrito.find(item => item.id === productoId);
    if (!item) return;

    // Resetear la cantidad en la lista de productos
    const qtyDisplay = document.getElementById(`qty-${productoId}`);
    if (qtyDisplay) qtyDisplay.textContent = '0';

    // Eliminar del carrito
    carrito = carrito.filter(item => item.id !== productoId);
    renderizarCarrito();
}

function renderizarCarrito() {
    const carritoDiv = document.getElementById('carrito-items');
    const subtotalDisplay = document.getElementById('subtotalPedido');
    const totalFinalDisplay = document.getElementById('totalFinalPedido');
    const btnEnviar = document.getElementById('btn-enviar-pedido');
    
    if (carrito.length === 0) {
        carritoDiv.innerHTML = 'El carrito est√° vac√≠o.';
        subtotalDisplay.textContent = '$0 COP';
        totalFinalDisplay.textContent = '$0 COP';
        btnEnviar.disabled = true;
        return;
    }
    
    btnEnviar.disabled = false;
    let subtotal = 0;
    let html = '';

    carrito.forEach(item => {
        subtotal += item.subtotal;
        html += `
            <div class="producto-card" style="background-color: #2c2c2c;">
                <div class="producto-info">
                    <h4>${item.nombre} x ${item.cantidad}</h4>
                    <p>Total: $${item.subtotal.toLocaleString('es-CO')} COP</p>
                </div>
                <button class="btn-danger" style="padding: 5px 10px;" onclick="eliminarItemCarrito(${item.id})">‚ùå</button>
            </div>
        `;
    });

    carritoDiv.innerHTML = html;
    subtotalDisplay.textContent = `$${subtotal.toLocaleString('es-CO')} COP`;
    totalFinalDisplay.textContent = `$${subtotal.toLocaleString('es-CO')} COP`; // Por ahora sin puntos
}

async function enviarPedidoWhatsApp() {
    if (carrito.length === 0) {
        alert('El carrito est√° vac√≠o. Agregue productos antes de enviar.');
        return;
    }

    const nombre = document.getElementById("nombreCliente").value.trim();
    const telefonoCliente = document.getElementById("telefonoCliente").value.trim();

    // Obtener n√∫mero de WhatsApp del administrador (desde la configuraci√≥n)
    const formData = new FormData();
    formData.append('action', 'obtenerConfiguracion');
    const configResponse = await fetch(GOOGLE_SHEETS_API, { method: 'POST', body: formData });
    const configData = await configResponse.json();
    const numeroAdmin = configData.config ? configData.config.numero_wimpy : '57311XXXXXXX'; // Fallback
    
    // Construir mensaje
    let mensaje = `*üö® NUEVO PEDIDO WIMPY üö®*\n\n`;
    mensaje += `*Cliente:* ${nombre}\n`;
    mensaje += `*Tel√©fono:* ${telefonoCliente}\n`;
    mensaje += `*------------------------------*\n`;
    mensaje += `*DETALLE DEL PEDIDO:*\n`;
    
    let subtotal = 0;
    carrito.forEach(item => {
        mensaje += `  - ${item.cantidad} x ${item.nombre} ($${item.precio.toLocaleString('es-CO')})\n`;
        subtotal += item.subtotal;
    });
    
    mensaje += `*------------------------------*\n`;
    mensaje += `*SUBTOTAL:* $${subtotal.toLocaleString('es-CO')} COP\n`;
    mensaje += `(Precio final a confirmar por el administrador)\n\n`;
    mensaje += `*¬øDesea confirmar o rechazar este pedido?*`;

    // Codificar para URL
    const url = `https://wa.me/${numeroAdmin}?text=${encodeURIComponent(mensaje)}`;
    
    // Abrir WhatsApp
    window.open(url, '_blank');
    
    // Limpiar carrito despu√©s de enviar (asumiendo que fue exitoso)
    carrito = [];
    document.getElementById("nombreCliente").value = '';
    document.getElementById("telefonoCliente").value = '';
    document.getElementById("autorizaDatos").checked = false;
    mostrar('vista-inicial');
    alert('Pedido enviado a WhatsApp del administrador. Espere la confirmaci√≥n.');
}

// ------------------------------------------------------------------
// --- GESTI√ìN DE PUNTOS, CONFIGURACI√ìN, CRUD, HISTORIAL (Se mantienen) ---
// ------------------------------------------------------------------
// ... (Aqu√≠ ir√≠a el resto de funciones del manual anterior, como: 
// cargarPoliticaUrl, buscarPuntosCliente, cargarConfiguracion, guardarConfiguracion, 
// cargarClientes, agregarCliente, abrirEdicionCliente, guardarEdicionCliente, eliminarCliente, 
// cargarProductos (Admin), agregarProducto, abrirEdicionProducto, guardarEdicionProducto, 
// eliminarProducto, cargarHistorial, generarContactosPromocionales) ...

// Nota: La funci√≥n registrarPedido del backend ya no se llama desde el cliente, 
// sino que ser√≠a llamada manualmente por el administrador si desea registrar la venta final 
// en la hoja de Historial despu√©s de confirmar por WhatsApp.
</script>

<section id="configuracion" class="oculto admin-section">
    </section>
<section id="clientes" class="oculto admin-section">
    </section>
<section id="productos" class="oculto admin-section">
    </section>
<section id="historial" class="oculto admin-section">
    </section>
<section id="mensajeria" class="oculto admin-section">
    </section>
<div id="agregarClienteModal" class="modal oculto">...</div>
<div id="editarClienteModal" class="modal oculto">...</div>
<div id="agregarProductoModal" class="modal oculto">...</div>
<div id="editarProductoModal" class="modal oculto">...</div>
</body>
</html>
