<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wimpy Super App - Admin</title>
    <style>
        /* Dise√±o Moderno y Estructurado (Opci√≥n 2) */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: #1a1a2e; /* Fondo Oscuro Profundo */
            color: #e0e0e0; 
            margin: 0; 
            padding: 0; 
        }
        header { 
            background-color: #16213e; 
            padding: 20px; 
            text-align: center; 
            font-size: 1.6em; 
            color: #fff; 
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        nav { 
            display: flex; 
            justify-content: center; 
            background-color: #1f1f3e; 
            padding: 12px 0; 
            position: sticky; 
            top: 0; 
            z-index: 1000;
        }
        nav button { 
            background-color: #4e44e2; 
            color: #fff; 
            border: none; 
            padding: 10px 18px; 
            margin: 0 8px;
            border-radius: 6px; 
            cursor: pointer; 
            transition: background-color 0.3s, transform 0.1s;
            font-weight: 600;
        }
        nav button:hover { 
            background-color: #3f35c7; 
            transform: translateY(-1px); 
        }
        section { 
            padding: 20px; 
            max-width: 1000px; 
            margin: 0 auto; 
        }
        .oculto { 
            display: none; 
        }
        .admin-btn { 
            position: fixed; 
            bottom: 20px; 
            right: 20px; 
            background: #e94560; 
            color: white; 
            padding: 15px; 
            border: none; 
            border-radius: 50%; 
            font-size: 1.4em; 
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            transition: background-color 0.3s;
        }
        .admin-btn:hover {
            background: #d43450;
        }
        .card {
            background-color: #1f1f3e;
            padding: 25px;
            margin-bottom: 20px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        h2, h3 { 
            color: #90d7ff; 
            border-bottom: 2px solid #3f35c7; 
            padding-bottom: 5px; 
            margin-top: 0;
        }
        label { 
            display: block; 
            margin-top: 15px; 
            font-weight: 500; 
            color: #ccc;
        }
        input[type="text"], input[type="email"], textarea, input[type="number"] {
            width: calc(100% - 20px);
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #3f35c7;
            border-radius: 6px;
            background-color: #2b2a4a;
            color: #e0e0e0;
            box-sizing: border-box;
        }
        .btn {
            background-color: #4e44e2; 
            color: white; 
            padding: 10px 20px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            margin-top: 20px;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        .btn:hover {
            background-color: #3f35c7;
        }
        .btn-factura {
            background-color: #00b894;
            margin-right: 15px;
        }
        .btn-factura:hover {
            background-color: #00a082;
        }
        .btn-red {
            background-color: #e94560;
        }
        .btn-red:hover {
            background-color: #d43450;
        }
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .mensaje {
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-weight: bold;
        }
        .success { background-color: #2e7d32; color: white; }
        .error { background-color: #c62828; color: white; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #3f35c7;
        }
        th {
            background-color: #16213e;
            color: #90d7ff;
        }
    </style>
</head>
<body>

<header>Wimpy Super App</header>

<nav id="navAdmin" class="oculto">
    <button onclick="mostrar('adminPanel')">üè† Dashboard</button>
    <button onclick="mostrar('gestionClientes'); obtenerClientes()">üë• Clientes</button>
    <button onclick="mostrar('gestionProductos'); obtenerProductosAdmin()">üçï Productos</button>
    <button onclick="mostrar('historial'); obtenerHistorial()">üßæ Historial</button>
    <button onclick="mostrar('configuracion')">‚öôÔ∏è Configuraci√≥n</button>
    <button onclick="mostrar('facturacion')">üí∞ Facturaci√≥n</button>
</nav>

<section id="pedido" class="card">
    <h2>Realizar Pedido</h2>
    <div id="pedidoMessage" class="mensaje oculto"></div>
    <label for="nombreCliente">Nombre:</label>
    <input type="text" id="nombreCliente" placeholder="Ej: Edwin (Empleado)">
    
    <label for="telefonoCliente">Tel√©fono:</label>
    <input type="text" id="telefonoCliente" placeholder="Ej: 573001234567">
    
    <label for="detallePedido">Detalle del Pedido (Producto, Cantidad):</label>
    <textarea id="detallePedido" rows="4"></textarea>

    <label for="totalPedido">Valor Total:</label>
    <input type="number" id="totalPedido" placeholder="Ej: 15000">

    <button class="btn" onclick="registrarPedido()">Registrar Pedido</button>
</section>

<section id="adminPanel" class="oculto card">
    <h2>Dashboard Administrativo</h2>
    <p>Indicadores autom√°ticos (STUB):</p>
    <ul>
        <li>Ventas totales del mes: **$1,500,000** (STUB)</li>
        <li>Pedidos pendientes: **5** (STUB)</li>
        <li>Total de clientes activos: **12** (STUB)</li>
        <li>Estado del Men√∫: <span id="menuStatus">Cargando...</span></li>
    </ul>
</section>

<section id="gestionClientes" class="oculto card">
    <h2>üë• Gesti√≥n de Clientes</h2>
    <div id="clienteMessage" class="mensaje oculto"></div>
    
    <div class="card">
        <h3>A√±adir Nuevo Cliente</h3>
        <label for="newClienteNombre">Nombre:</label>
        <input type="text" id="newClienteNombre" placeholder="Nombre completo">
        <label for="newClienteTelefono">Tel√©fono (Clave de eliminaci√≥n):</label>
        <input type="text" id="newClienteTelefono" placeholder="Tel√©fono √∫nico">
        <button class="btn" onclick="agregarCliente()">A√±adir Cliente</button>
    </div>

    <h3>Clientes Registrados</h3>
    <table id="tablaClientes">
        <thead><tr><th>Nombre</th><th>Tel√©fono</th><th>Empresa ID</th><th>Acci√≥n</th></tr></thead>
        <tbody></tbody>
    </table>
</section>

<section id="gestionProductos" class="oculto card">
    <h2>üçï Gesti√≥n de Productos</h2>
    <div id="productoMessage" class="mensaje oculto"></div>
    
    <div class="card">
        <h3>A√±adir Nuevo Producto</h3>
        <label for="newProductoNombre">Nombre:</label>
        <input type="text" id="newProductoNombre" placeholder="Ej: Sandwich Cl√°sico">
        <label for="newProductoPrecio">Precio:</label>
        <input type="number" id="newProductoPrecio" placeholder="Ej: 8500">
        <button class="btn" onclick="agregarProducto()">A√±adir Producto</button>
    </div>

    <h3>Productos Disponibles</h3>
    <table id="tablaProductos">
        <thead><tr><th>ID</th><th>Nombre</th><th>Precio</th><th>Activo</th><th>Acci√≥n</th></tr></thead>
        <tbody></tbody>
    </table>
</section>

<section id="historial" class="oculto card">
    <h2>üßæ Historial de Pedidos</h2>
    <table id="tablaHistorial">
        <thead><tr><th>Fecha</th><th>Cliente</th><th>Total</th><th>Estado</th><th>Empresa</th></tr></thead>
        <tbody></tbody>
    </table>
</section>

<section id="configuracion" class="oculto card">
    <h2>‚öôÔ∏è Configuraci√≥n Empresarial</h2>
    <div id="configMessage" class="mensaje oculto"></div>

    <div class="grid-2">
        <div class="card">
            <h3>üè¢ Datos de Wimpy (Tu Empresa)</h3>
            <label for="wimpyNombre">Nombre:</label>
            <input type="text" id="wimpyNombre">
            
            <label for="wimpyNIT">NIT:</label>
            <input type="text" id="wimpyNIT">
            
            <label for="wimpyDireccion">Direcci√≥n:</label>
            <input type="text" id="wimpyDireccion">

            <label for="wimpyTelefono">Tel√©fono:</label>
            <input type="text" id="wimpyTelefono">

            <label for="wimpyCorreo">Correo:</label>
            <input type="email" id="wimpyCorreo">
            
            <p style="font-size:0.9em; margin-top: 15px;">**Logo y Firma:** Sube las im√°genes a tu carpeta **Wimpy_Assets** en Drive. <br>URL de Assets: <span id="assetsURL">Cargando...</span></p>

            <button class="btn" onclick="guardarConfiguracionWimpy()">Guardar Datos de Wimpy</button>
        </div>

        <div class="card">
            <h3>üíº Datos de la Empresa Contratante (ID 1)</h3>
            <label for="empresaNombre">Nombre de la Empresa:</label>
            <input type="text" id="empresaNombre">
            
            <label for="empresaNIT">NIT de la Empresa:</label>
            <input type="text" id="empresaNIT">
            
            <label for="empresaCorreo">Correo Destinatario:</label>
            <input type="email" id="empresaCorreo">

            <label for="empresaContacto">A Qui√©n Va Dirigida:</label>
            <input type="text" id="empresaContacto">

            <button class="btn" onclick="guardarEmpresaContratante()">Guardar Datos Contratante</button>
        </div>
    </div>
</section>

<section id="facturacion" class="oculto card">
    <h2>üí∞ Facturaci√≥n y Reportes Mensuales</h2>
    <div id="facturaMessage" class="mensaje oculto"></div>
    <p>Mes y Empresa por defecto: <span id="facturaData">Octubre 2025 / TecnoSoluciones S.A.S.</span></p>

    <h3>Generar Documentos</h3>
    <button class="btn btn-factura" onclick="generarCuentaCobroPDF()">1. Generar Cuenta de Cobro PDF</button>
    <button class="btn btn-factura" onclick="generarDetalleExcel()">2. Generar Detalle Excel por Empleado</button>
    <button class="btn" onclick="reenviarEmailCuentaCobro()">3. Reenviar Cuenta de Cobro (sin regenerar)</button>
</section>

<button class="admin-btn" onclick="accederAdmin()">üîí</button>


<script>
// ¬°IMPORTANTE! REEMPLAZA ESTA URL CON LA URL DE DESPLIEGUE DE TU APPS SCRIPT.
const GOOGLE_SHEETS_API = 'REEMPLAZAR_CON_TU_URL_DE_APPS_SCRIPT_FINAL'; 
let adminAcceso = false;
const ADMIN_PIN_CLIENTE = "1995"; // PIN para el prompt inicial

// ------------------------------------------------------------------
// --- UTILIDADES ---
// ------------------------------------------------------------------

function mostrar(seccion) {
    document.querySelectorAll('section').forEach(s => s.classList.add('oculto'));
    document.getElementById(seccion).classList.remove('oculto');
}

document.addEventListener('DOMContentLoaded', () => {
    obtenerConfiguracionPublica();
    mostrar('pedido');
});

function mostrarMensaje(elementId, message, type) {
    const el = document.getElementById(elementId);
    el.textContent = message;
    el.className = `mensaje ${type}`;
    el.classList.remove('oculto');
    setTimeout(() => el.classList.add('oculto'), 5000);
}

// ------------------------------------------------------------------
// --- AUTENTICACI√ìN Y CARGA DE DATOS ---
// ------------------------------------------------------------------

function accederAdmin() {
    if (adminAcceso) {
        if (confirm("¬øCerrar sesi√≥n de administrador?")) {
            adminAcceso = false;
            document.getElementById('navAdmin').classList.add('oculto');
            mostrar('pedido');
            alert("Sesi√≥n cerrada.");
        }
        return;
    }
    
    const pin = prompt("üîí Ingrese el PIN de administrador:");
    if (pin === ADMIN_PIN_CLIENTE) { 
        adminAcceso = true;
        alert("Acceso concedido ‚úÖ. Panel de Administraci√≥n visible.");
        document.getElementById('navAdmin').classList.remove('oculto');
        
        // Carga de datos de configuraci√≥n al acceder
        obtenerDatosAdmin();
        mostrar('adminPanel');
    } else {
        alert("PIN incorrecto o acceso denegado ‚ùå");
    }
}

async function obtenerDatosAdmin() {
    if (!adminAcceso) return;

    // 1. Obtener Configuraci√≥n de Wimpy y Empresas
    try {
        const formData = new FormData();
        formData.append('action', 'obtenerConfiguracion'); // STUB: No implementado en el backend, usar l√≥gica directa
        formData.append('pin', ADMIN_PIN_CLIENTE);
        
        // Asumiendo que obtienes la configuraci√≥n de Wimpy y Empresa ID 1:
        const config = await llamarAPIAdmin('obtenerConfiguracionMap'); // Nueva funci√≥n STUB en backend
        const empresa = await llamarAPIAdmin('obtenerEmpresaContratante');
        
        // Rellenar Configuraci√≥n de Wimpy (Ejemplo con STUB)
        document.getElementById('wimpyNombre').value = "Wimpy Restaurante & Cafeter√≠a";
        document.getElementById('wimpyNIT').value = "900123456-7";
        document.getElementById('assetsURL').textContent = "Cargando..."; // Se actualizar√° en el POST

        // Rellenar Empresa Contratante (Usando datos reales del backend)
        if (empresa.success) {
            document.getElementById('empresaNombre').value = empresa.empresa.nombre;
            document.getElementById('empresaNIT').value = empresa.empresa.nit;
            document.getElementById('empresaCorreo').value = empresa.empresa.correo;
            document.getElementById('empresaContacto').value = empresa.empresa.contacto;
            
            document.getElementById('facturaData').textContent = `Mes Actual / ${empresa.empresa.nombre}`;
        }
        
    } catch (e) {
        console.error("Error al cargar datos administrativos:", e);
    }
}

async function llamarAPIAdmin(action, params = {}) {
    if (!adminAcceso) return { success: false, error: "Acceso restringido" };
    
    const formData = new FormData();
    formData.append('action', action);
    formData.append('pin', ADMIN_PIN_CLIENTE); 
    
    for (const key in params) {
        formData.append(key, params[key]);
    }

    try {
        const response = await fetch(GOOGLE_SHEETS_API, { method: 'POST', body: formData });
        return await response.json();
    } catch (error) {
        return { success: false, error: 'Error de conexi√≥n con la API.' };
    }
}

// ------------------------------------------------------------------
// --- FUNCIONES DE PEDIDO (P√∫blicas) ---
// ------------------------------------------------------------------

async function obtenerConfiguracionPublica() {
    // Implementaci√≥n para obtener estado del men√∫
}

async function registrarPedido() {
    const nombre = document.getElementById("nombreCliente").value.trim();
    const telefono = document.getElementById("telefonoCliente").value.trim();
    const detalle = document.getElementById("detallePedido").value.trim();
    const total = document.getElementById("totalPedido").value.trim();

    if (!nombre || !telefono || !detalle || !total) {
        mostrarMensaje('pedidoMessage', "Por favor, complete todos los campos del pedido.", 'error');
        return;
    }
    
    const formData = new FormData();
    formData.append('action', 'registrarPedido');
    formData.append('nombre', nombre);
    formData.append('telefono', telefono);
    formData.append('detalle', detalle);
    formData.append('total', total);
    
    const data = await llamarAPIAdmin('registrarPedido', { nombre, telefono, detalle, total });

    if (data.success) {
        mostrarMensaje('pedidoMessage', "‚úÖ Pedido registrado: " + data.message, 'success');
        document.getElementById("nombreCliente").value = '';
        document.getElementById("detallePedido").value = '';
        // Tel√©fono y total se pueden mantener si el empleado hace varios
    } else {
        mostrarMensaje('pedidoMessage', "Error al registrar: " + data.error, 'error');
    }
}

// ------------------------------------------------------------------
// --- GESTI√ìN DE CLIENTES (CRUD) ---
// ------------------------------------------------------------------

async function obtenerClientes() {
    const data = await llamarAPIAdmin('obtenerClientes');
    const tbody = document.querySelector('#tablaClientes tbody');
    tbody.innerHTML = '';
    
    if (data.success && data.clientes) {
        data.clientes.forEach(cliente => {
            const row = tbody.insertRow();
            row.insertCell().textContent = cliente.nombre;
            row.insertCell().textContent = cliente.telefono;
            row.insertCell().textContent = cliente.idEmpresa || 1;
            const cellAccion = row.insertCell();
            const btn = document.createElement('button');
            btn.textContent = 'Eliminar';
            btn.className = 'btn btn-red';
            btn.onclick = () => eliminarCliente(cliente.telefono);
            cellAccion.appendChild(btn);
        });
    } else {
        tbody.innerHTML = '<tr><td colspan="4">No hay clientes registrados.</td></tr>';
    }
}

async function agregarCliente() {
    const nombre = document.getElementById('newClienteNombre').value.trim();
    const telefono = document.getElementById('newClienteTelefono').value.trim();
    
    if (!nombre || !telefono) {
        mostrarMensaje('clienteMessage', 'Nombre y tel√©fono son obligatorios.', 'error');
        return;
    }
    
    const data = await llamarAPIAdmin('agregarCliente', { nombre, telefono, idEmpresa: 1 });
    
    if (data.success) {
        mostrarMensaje('clienteMessage', data.message, 'success');
        document.getElementById('newClienteNombre').value = '';
        document.getElementById('newClienteTelefono').value = '';
        obtenerClientes(); // Recargar la tabla
    } else {
        mostrarMensaje('clienteMessage', data.error, 'error');
    }
}

async function eliminarCliente(telefono) {
    if (!confirm(`¬øEst√° seguro de eliminar al cliente con tel√©fono ${telefono}?`)) return;
    
    const data = await llamarAPIAdmin('eliminarCliente', { telefono });
    
    if (data.success) {
        mostrarMensaje('clienteMessage', data.message, 'success');
        obtenerClientes(); // Recargar la tabla
    } else {
        mostrarMensaje('clienteMessage', data.error, 'error');
    }
}

// ------------------------------------------------------------------
// --- GESTI√ìN DE PRODUCTOS (CRUD) ---
// ------------------------------------------------------------------

async function obtenerProductosAdmin() {
    const data = await llamarAPIAdmin('obtenerProductosAdmin');
    const tbody = document.querySelector('#tablaProductos tbody');
    tbody.innerHTML = '';
    
    if (data.success && data.productos) {
        data.productos.forEach(producto => {
            const row = tbody.insertRow();
            row.insertCell().textContent = producto.id;
            row.insertCell().textContent = producto.nombre;
            row.insertCell().textContent = producto.precio;
            row.insertCell().textContent = producto.activo ? 'S√≠' : 'No';
            const cellAccion = row.insertCell();
            const btn = document.createElement('button');
            btn.textContent = 'Eliminar';
            btn.className = 'btn btn-red';
            btn.onclick = () => eliminarProducto(producto.id);
            cellAccion.appendChild(btn);
        });
    } else {
        tbody.innerHTML = '<tr><td colspan="5">No hay productos registrados.</td></tr>';
    }
}

async function agregarProducto() {
    const nombre = document.getElementById('newProductoNombre').value.trim();
    const precio = document.getElementById('newProductoPrecio').value.trim();
    
    if (!nombre || !precio) {
        mostrarMensaje('productoMessage', 'Nombre y precio son obligatorios.', 'error');
        return;
    }
    
    const data = await llamarAPIAdmin('agregarProducto', { nombre, precio });
    
    if (data.success) {
        mostrarMensaje('productoMessage', data.message, 'success');
        document.getElementById('newProductoNombre').value = '';
        document.getElementById('newProductoPrecio').value = '';
        obtenerProductosAdmin();
    } else {
        mostrarMensaje('productoMessage', data.error, 'error');
    }
}

async function eliminarProducto(idProducto) {
    if (!confirm(`¬øEst√° seguro de eliminar el producto ID ${idProducto}?`)) return;
    
    const data = await llamarAPIAdmin('eliminarProducto', { idProducto });
    
    if (data.success) {
        mostrarMensaje('productoMessage', data.message, 'success');
        obtenerProductosAdmin();
    } else {
        mostrarMensaje('productoMessage', data.error, 'error');
    }
}

// ------------------------------------------------------------------
// --- GESTI√ìN DE FACTURACI√ìN (LLAMADAS STUB) ---
// ------------------------------------------------------------------

async function llamarFacturacion(action) {
    const data = await llamarAPIAdmin(action, { idEmpresa: 1, mesFacturado: 'Octubre 2025' });

    if (data.success) {
        mostrarMensaje('facturaMessage', data.message, 'success');
        // Si el backend devuelve la URL de assets, la actualizamos
        if (data.assetsUrl) {
            document.getElementById('assetsURL').textContent = data.assetsUrl;
        }
    } else {
        mostrarMensaje('facturaMessage', 'Error: ' + data.error, 'error');
    }
}

function generarCuentaCobroPDF() {
    llamarFacturacion('generarCuentaCobroPDF');
}

function generarDetalleExcel() {
    llamarFacturacion('generarDetalleExcel');
}

function reenviarEmailCuentaCobro() {
    llamarFacturacion('reenviarEmailCuentaCobro');
}

// ------------------------------------------------------------------
// --- GESTI√ìN DE CONFIGURACI√ìN (Guarda campos individuales) ---
// ------------------------------------------------------------------

async function guardarConfiguracionWimpy() {
    const campos = {
        'WIMPY_NOMBRE': document.getElementById('wimpyNombre').value.trim(),
        'WIMPY_NIT': document.getElementById('wimpyNIT').value.trim(),
        'WIMPY_DIRECCION': document.getElementById('wimpyDireccion').value.trim(),
        'WIMPY_TELEFONO': document.getElementById('wimpyTelefono').value.trim(),
        'WIMPY_CORREO': document.getElementById('wimpyCorreo').value.trim(),
        // STUB para crear carpeta de Assets la primera vez
        'WIMPY_LOGO_URL': true // Se usa un valor booleano para disparar la l√≥gica de creaci√≥n de Drive en el backend
    };

    let allSuccess = true;
    for (const [campo, valor] of Object.entries(campos)) {
        const data = await llamarAPIAdmin('guardarConfiguracionWimpy', { campo, valor });
        if (!data.success) {
            allSuccess = false;
            mostrarMensaje('configMessage', `Error al guardar ${campo}: ${data.error}`, 'error');
            break;
        } else if (campo === 'WIMPY_LOGO_URL' && data.assetsUrl) {
            // Si es la URL de Assets, actualizamos la interfaz
            document.getElementById('assetsURL').textContent = data.assetsUrl;
        }
    }

    if (allSuccess) {
        mostrarMensaje('configMessage', '‚úÖ Configuraci√≥n de Wimpy guardada correctamente.', 'success');
    }
}

async function guardarEmpresaContratante() {
    const params = {
        idEmpresa: 1,
        nombre: document.getElementById('empresaNombre').value.trim(),
        nit: document.getElementById('empresaNIT').value.trim(),
        correo: document.getElementById('empresaCorreo').value.trim(),
        contacto: document.getElementById('empresaContacto').value.trim()
    };
    
    const data = await llamarAPIAdmin('guardarEmpresaContratante', params);
    
    if (data.success) {
        mostrarMensaje('configMessage', '‚úÖ Datos de la Empresa Contratante guardados.', 'success');
    } else {
        mostrarMensaje('configMessage', 'Error al guardar empresa: ' + data.error, 'error');
    }
}

</script>
</body>
</html>
