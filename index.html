<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wimpy App</title>
    <style>
        /* Estilos generales */
        body { font-family: Arial, sans-serif; background-color: #121212; color: #e0e0e0; margin: 0; padding: 0; }
        header { background-color: #1f1f1f; padding: 15px; text-align: center; font-size: 1.4em; color: #fff; }
        .main-nav { display: flex; justify-content: center; background-color: #1f1f1f; padding: 20px; gap: 20px; }
        /* Botones de navegaci√≥n principal y men√∫ de cliente */
        .main-nav button, #menu-cliente button, #admin-panel-menu nav button { 
            background-color: #4e44e2; 
            color: #fff; 
            border: none; 
            padding: 15px 30px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 1.1em; 
            transition: background-color 0.3s; 
            flex-grow: 1; 
        }
        .main-nav button:hover, #menu-cliente button:hover { background-color: #332a9e; }
        section { padding: 15px; }
        .oculto { display: none; }
        
        /* Estilos de Botones y Formularios */
        label { display: block; margin-top: 10px; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="number"], input[type="password"], textarea { width: 95%; padding: 10px; margin-bottom: 10px; border: 1px solid #333; border-radius: 4px; background-color: #2c2c2c; color: #e0e0e0; }
        .btn { background-color: #4e44e2; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px; }
        .btn-secondary { background-color: #555; }
        .btn-danger { background-color: #e24444; }
        .btn-whatsapp { background-color: #25D366; color: white; padding: 15px; font-size: 1.2em; margin-top: 20px; width: 100%; }

        /* Estilos del Carrito y Mensajes */
        .mensaje { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .mensaje.success { background-color: #44e24e50; border: 1px solid #44e24e; color: #fff; }
        .mensaje.error { background-color: #e2444450; border: 1px solid #e24444; color: #fff; }
        
        /* Admin */
        #admin-panel-menu { margin-top: 20px; }
        #admin-panel-menu nav { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
    </style>
</head>
<body>

<header>Wimpy App</header>

<div id="vista-inicial" class="main-nav">
    <button onclick="iniciarSesionCliente()">üõí Clientes</button>
    <button onclick="accederAdmin()">üíº Administrador</button>
</div>

<section id="cliente" class="oculto">
    
    <div id="datos-cliente-form">
        <h2>üëã Ingrese su Tel√©fono</h2>
        <div id="clienteMessage" class="mensaje oculto"></div>
        <label for="telefonoCliente">Su Tel√©fono (WhatsApp):</label>
        <input type="number" id="telefonoCliente" oninput="validarTelefonoYBuscarInfo()" required>
        
        <div id="client-info-display" class="oculto" style="margin-top: 15px; padding: 10px; border: 1px solid #4e44e2; border-radius: 5px; background-color: #333;">
            <p>Cliente: <strong id="cliente-nombre-display"></strong></p>
            <p>Puntos Disponibles: <strong id="puntos-disponibles-display">0</strong></p>
        </div>

        <div style="margin-top: 15px; border: 1px dashed #555; padding: 10px; border-radius: 5px;">
            <input type="checkbox" id="autorizaDatos" style="transform: scale(1.2); margin-right: 5px;">
            <label for="autorizaDatos" style="display: inline;">Autorizo el tratamiento de mis datos personales seg√∫n la <a href="#" id="politicaLink" target="_blank" style="color: #4e44e2;">Pol√≠tica de Wimpy</a>.</label>
        </div>
        <button class="btn" onclick="iniciarPedido()" id="btn-iniciar-pedido" disabled>Acceder al Men√∫</button>
        <button class="btn btn-secondary" onclick="mostrar('vista-inicial')" style="width: 100%; margin-top: 15px;">‚¨ÖÔ∏è Regresar</button>
    </div>

    <div id="menu-cliente" class="oculto">
        <h2 style="text-align: center;"><span id="cliente-nombre-menu"></span>, ¬°qu√© bueno verte de nuevo!</h2>
        <div class="main-nav" style="flex-direction: column; padding: 10px 0;">
            <button onclick="mostrarAreaPedido()">üõí **Hacer Nuevo Pedido**</button>
            <button onclick="mostrarConfirmacionRecibido()">‚úÖ **Confirmar Recibido de Pedidos**</button>
            <button class="btn-secondary" onclick="iniciarSesionCliente()" style="background-color: #333; margin-top: 20px; color: #ccc;">‚¨ÖÔ∏è Cambiar Cliente / Salir</button>
        </div>
    </div>

    <div id="area-pedido" class="oculto">
        <h3 style="margin-top: 20px;">üçΩÔ∏è Men√∫ Disponible</h3>
        <div id="lista-productos">Cargando productos...</div>

        <button class="btn btn-whatsapp" onclick="enviarPedidoWhatsApp()" id="btn-enviar-pedido" disabled>
            <span style="font-size: 1.5em; margin-right: 10px;">üí¨</span> Enviar Pedido por WhatsApp
        </button>
        <button class="btn btn-secondary" onclick="iniciarPedido()" style="width: 100%; margin-top: 15px;">‚¨ÖÔ∏è Volver al Men√∫ Principal</button>
    </div>

    <div id="area-confirmar-recibido" class="oculto">
        <h3 style="margin-top: 20px;">‚úÖ Pedidos por Confirmar Recibido</h3>
        <div id="lista-pedidos-recibir">Cargando pedidos pendientes...</div>
        <button class="btn btn-secondary" onclick="iniciarPedido()" style="width: 100%; margin-top: 15px;">‚¨ÖÔ∏è Volver al Men√∫ Principal</button>
    </div>

</section>

<section id="admin" class="oculto">
    <h2>Panel de Administrador</h2>
    <div id="adminMessage" class="mensaje oculto"></div>
    
    <div id="admin-login">
        <label for="adminPin">PIN de Administrador:</label>
        <input type="password" id="adminPin">
        <button class="btn" onclick="iniciarSesionAdmin()">Acceder</button>
        <button class="btn btn-secondary" onclick="mostrar('vista-inicial')" style="width: 100%; margin-top: 15px;">‚¨ÖÔ∏è Regresar</button>
    </div>
    
    <div id="admin-panel-menu" class="oculto">
        <nav>
            <button onclick="mostrarAdminSection('configuracion')">‚öôÔ∏è Configuraci√≥n</button>
            <button onclick="mostrarAdminSection('clientes')">üë• Clientes</button>
            <button class="btn-danger" onclick="adminLogout()" style="flex-grow: 0;">üîí Salir</button>
        </nav>
        <div id="admin-content">
            <p>Seleccione una opci√≥n del men√∫ superior.</p>
        </div>
    </div>

    <div id="configuracion" class="oculto admin-section">
        <h3>1. Configuraci√≥n General</h3>
        <label for="numeroWimpy">N√∫mero WhatsApp Wimpy (para pedidos):</label>
        <input type="text" id="numeroWimpy">
        
        <label for="programaPuntosActivo">Programa de Puntos Activo:</label>
        <select id="programaPuntosActivo">
            <option value="S√≠">S√≠</option>
            <option value="No">No</option>
        </select>

        <label for="valorPunto">Valor de 1 Punto (COP en descuento):</label>
        <input type="number" id="valorPunto">

        <h3 style="margin-top: 30px;">2. Datos para Cuenta de Cobro (Wimpy)</h3>
        <label for="nombreWimpyFactura">Nombre/Raz√≥n Social Wimpy:</label>
        <input type="text" id="nombreWimpyFactura">
        <label for="nitWimpyFactura">NIT de Wimpy:</label>
        <input type="text" id="nitWimpyFactura">
        
        <h3 style="margin-top: 30px;">3. Datos de la Empresa Cliente (Cuenta de Cobro)</h3>
        <label for="nombreEmpresa">Nombre de la Empresa Cliente:</label>
        <input type="text" id="nombreEmpresa">
        <label for="nitEmpresa">NIT de la Empresa Cliente:</label>
        <input type="text" id="nitEmpresa">

        <button class="btn" onclick="guardarConfiguracion()">üíæ Guardar Configuraci√≥n</button>
    </div>

    </section>

<script>
// === CONFIGURACI√ìN CR√çTICA DEL SISTEMA ===
const GOOGLE_SHEETS_API = 'https://script.google.com/macros/s/AKfycbwvbXwdh3xtkbHWsfwDTJ7BNU5A2fwIAWrGZ40j8w2UyzJeKh_lfQ6zcasIDqPOoSSYPQ/exec'; 
const ADMIN_PIN_SECRETO = "1995"; 
const STORAGE_CONSENT = 'wimpy_data_consent'; 
let adminAcceso = false;
let puntosMaximos = 0; 
let valorPunto = 20; 
let clienteNombre = ''; 
let programaPuntosActivo = false; 
let productosDisponibles = []; 
let numeroWimpyWhatsApp = '57311XXXXXXX'; // Valor por defecto

// Inicializar la App
document.addEventListener('DOMContentLoaded', () => {
    mostrar('vista-inicial');
});

// ------------------------------------------------------------------
// --- UTILIDADES GLOBALES Y NAVEGACI√ìN ---
// ------------------------------------------------------------------

function mostrar(seccion) {
    // Escondemos todas las secciones y mostramos solo la solicitada
    document.querySelectorAll('section, .main-nav, #datos-cliente-form, #menu-cliente, #area-pedido, #area-confirmar-recibido, #admin-login, #admin-panel-menu').forEach(s => s.classList.add('oculto'));
    const sectionElement = document.getElementById(seccion);
    if (sectionElement) {
        sectionElement.classList.remove('oculto');
    }
}

function mostrarAdminSection(seccion) {
    document.querySelectorAll('.admin-section').forEach(s => s.classList.add('oculto'));
    const sectionElement = document.getElementById(seccion);
    if (sectionElement) {
        sectionElement.classList.remove('oculto');
        if (seccion === 'configuracion') {
            cargarConfiguracion();
        }
    }
}

function mostrarMensaje(id, texto, tipo) {
    const elemento = document.getElementById(id);
    elemento.innerHTML = texto;
    elemento.className = `mensaje ${tipo}`;
    elemento.classList.remove('oculto');
    setTimeout(() => {
        elemento.classList.add('oculto');
    }, 5000);
}

// ------------------------------------------------------------------
// --- CLIENTE: FLUJO DE ACCESO (CORREGIDO) ---
// ------------------------------------------------------------------

function iniciarSesionCliente() {
    mostrar('cliente');
    document.getElementById('datos-cliente-form').classList.remove('oculto');
    document.getElementById('telefonoCliente').value = '';
    document.getElementById('btn-iniciar-pedido').disabled = true; // El bot√≥n debe estar deshabilitado al inicio
    document.getElementById('client-info-display').classList.add('oculto');
    clienteNombre = '';
    puntosMaximos = 0;
}

async function validarTelefonoYBuscarInfo() {
    const telefono = document.getElementById('telefonoCliente').value.trim();
    const btnIniciar = document.getElementById('btn-iniciar-pedido');
    const infoDisplay = document.getElementById('client-info-display');
    btnIniciar.disabled = true; // Deshabilitar por defecto
    infoDisplay.classList.add('oculto');
    
    if (telefono.length < 7) { 
        document.getElementById('clienteMessage').classList.add('oculto');
        return; 
    }
    
    mostrarMensaje('clienteMessage', 'Buscando cliente y estado de pedidos...', 'success');

    const formData = new FormData();
    formData.append('action', 'obtenerInfoCliente'); 
    formData.append('telefono', telefono);
    
    try {
        const response = await fetch(GOOGLE_SHEETS_API, { method: 'POST', body: formData });
        const data = await response.json();
        
        document.getElementById('clienteMessage').classList.add('oculto');

        if (data.success) {
            
            if (data.hasPendingOrders) {
                mostrarMensaje('clienteMessage', 'üö® **Pedido Pendiente:** Debe esperar la confirmaci√≥n del administrador antes de hacer un nuevo pedido.', 'error');
                return;
            }

            // Actualizar variables globales con data REAL del servidor
            clienteNombre = data.nombre;
            puntosMaximos = data.puntos || 0;
            valorPunto = data.valorPunto || 20;
            programaPuntosActivo = data.programaPuntosActivo || false;
            numeroWimpyWhatsApp = data.numeroWimpy; // Usar el n√∫mero de la configuraci√≥n

            // Actualizar la vista de informaci√≥n
            document.getElementById('cliente-nombre-display').textContent = clienteNombre;
            document.getElementById('puntos-disponibles-display').textContent = puntosMaximos.toLocaleString('es-CO') + ' pts';
            infoDisplay.classList.remove('oculto');
            
            btnIniciar.disabled = false; // HABILITAR BOT√ìN AL ENCONTRAR CLIENTE Y NO TENER PEDIDOS PENDIENTES.

        } else {
             mostrarMensaje('clienteMessage', 'Cliente no registrado o error: ' + (data.error || 'Desconocido'), 'error');
        }

    } catch (error) {
        mostrarMensaje('clienteMessage', 'Error de conexi√≥n con la API.', 'error');
        console.error("Fetch Error:", error);
    }
}

/**
 * Transiciona del formulario de tel√©fono al Men√∫ Principal de Cliente. (CORREGIDO)
 */
function iniciarPedido() {
    const telefono = document.getElementById("telefonoCliente").value.trim();
    const autorizaDatos = document.getElementById("autorizaDatos").checked;
    
    // Verificaci√≥n de estado del bot√≥n deshabilitado
    if (document.getElementById('btn-iniciar-pedido').disabled) {
        mostrarMensaje('clienteMessage', 'Por favor, ingrese un tel√©fono v√°lido.', 'error');
        return;
    }

    if (!autorizaDatos) {
        mostrarMensaje('clienteMessage', 'Debe autorizar el tratamiento de datos para continuar.', 'error');
        return;
    }
    
    // CORRECCI√ìN: Navegaci√≥n correcta al men√∫
    document.getElementById('datos-cliente-form').classList.add('oculto');
    document.getElementById('area-pedido').classList.add('oculto');
    document.getElementById('area-confirmar-recibido').classList.add('oculto');
    document.getElementById('menu-cliente').classList.remove('oculto');

    // Implementaci√≥n del saludo personalizado
    document.getElementById('cliente-nombre-menu').textContent = clienteNombre;
}

function mostrarAreaPedido() {
    document.getElementById('menu-cliente').classList.add('oculto');
    document.getElementById('area-pedido').classList.remove('oculto');
}

function mostrarConfirmacionRecibido() {
    document.getElementById('menu-cliente').classList.add('oculto');
    document.getElementById('area-confirmar-recibido').classList.remove('oculto');
}


// ------------------------------------------------------------------
// --- ADMINISTRADOR: FLUJO DE ACCESO Y CONFIGURACI√ìN (CORREGIDO) ---
// ------------------------------------------------------------------

function accederAdmin() {
    mostrar('admin');
    document.getElementById('admin-login').classList.remove('oculto');
    document.getElementById('admin-panel-menu').classList.add('oculto');
    document.getElementById('adminPin').value = '';
}

function iniciarSesionAdmin() {
    const pin = document.getElementById('adminPin').value.trim();
    if (pin === ADMIN_PIN_SECRETO) {
        adminAcceso = true;
        document.getElementById('admin-login').classList.add('oculto');
        document.getElementById('admin-panel-menu').classList.remove('oculto');
        mostrarMensaje('adminMessage', 'Acceso concedido. Bienvenido.', 'success');
        mostrarAdminSection('configuracion'); 
    } else {
        mostrarMensaje('adminMessage', 'PIN incorrecto. Intente de nuevo.', 'error');
        adminAcceso = false;
    }
}

function adminLogout() {
    adminAcceso = false;
    mostrar('vista-inicial');
}

async function cargarConfiguracion() {
    const formData = new FormData();
    formData.append('action', 'obtenerConfiguracion'); 
    formData.append('pin', ADMIN_PIN_SECRETO); // Se env√≠a el PIN para la acci√≥n de administrador

    try {
        const response = await fetch(GOOGLE_SHEETS_API, { method: 'POST', body: formData });
        const data = await response.json();

        if (data.success) {
            const config = data.config;
            // Cargar datos a los inputs
            document.getElementById('numeroWimpy').value = config.numero_wimpy || '';
            document.getElementById('valorPunto').value = config.VALOR_PUNTO_PESOS || '';
            document.getElementById('programaPuntosActivo').value = config.PROGRAMA_PUNTOS_ACTIVO || 'No';

            document.getElementById('nombreWimpyFactura').value = config.WIMPY_NOMBRE_FACTURA || '';
            document.getElementById('nitWimpyFactura').value = config.WIMPY_NIT_FACTURA || '';
            
            document.getElementById('nombreEmpresa').value = config.EMPRESA_NOMBRE || '';
            document.getElementById('nitEmpresa').value = config.EMPRESA_NIT || '';
            
        } else {
            mostrarMensaje('adminMessage', 'Error al cargar configuraci√≥n: ' + (data.error || 'Desconocido'), 'error');
        }
    } catch (error) {
        mostrarMensaje('adminMessage', 'Error de conexi√≥n al cargar configuraci√≥n.', 'error');
    }
}

async function guardarConfiguracion() {
    if (!adminAcceso) return mostrarMensaje('adminMessage', 'Acceso restringido.', 'error');
    
    const formData = new FormData();
    formData.append('action', 'guardarConfiguracion');
    formData.append('pin', ADMIN_PIN_SECRETO);

    // Recoger todos los campos
    formData.append('numero_wimpy', document.getElementById('numeroWimpy').value.trim());
    formData.append('VALOR_PUNTO_PESOS', document.getElementById('valorPunto').value.trim());
    formData.append('PROGRAMA_PUNTOS_ACTIVO', document.getElementById('programaPuntosActivo').value);

    formData.append('WIMPY_NOMBRE_FACTURA', document.getElementById('nombreWimpyFactura').value.trim());
    formData.append('WIMPY_NIT_FACTURA', document.getElementById('nitWimpyFactura').value.trim());

    formData.append('EMPRESA_NOMBRE', document.getElementById('nombreEmpresa').value.trim());
    formData.append('EMPRESA_NIT', document.getElementById('nitEmpresa').value.trim());

    try {
        const response = await fetch(GOOGLE_SHEETS_API, { method: 'POST', body: formData });
        const data = await response.json();
        
        if (data.success) {
            mostrarMensaje('adminMessage', '‚úÖ Configuraci√≥n guardada con √©xito.', 'success');
        } else {
            mostrarMensaje('adminMessage', '‚ùå Error al guardar: ' + (data.error || 'Desconocido'), 'error');
        }
    } catch (error) {
        mostrarMensaje('adminMessage', 'Error de conexi√≥n al guardar configuraci√≥n.', 'error');
    }
}

</script>
</body>
</html>
