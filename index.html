<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üçî‚òï WimpyApp</title>

  <!-- React + ReactDOM + Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind CDN (modo oscuro forzado) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Forzar modo oscuro
    tailwind.config = {
      darkMode: 'class',
      theme: { extend: {} }
    }
  </script>

  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçî</text></svg>">

  <style>
    /* Forzar siempre tema oscuro */
    :root { color-scheme: dark; }
    html,body,#root { height: 100%; }
  </style>
</head>
<body class="dark bg-gray-900 text-gray-100 antialiased">
  <div id="root"></div>

  <script type="text/babel">

/* ===========================================================
   WimpyApp - Frontend v4.5 (React, un solo archivo)
   Conexi√≥n: Apps Script URL (tu endpoint)
   =========================================================== */

const { useState, useEffect, useMemo } = React;

// ===================== CONFIG =====================
const GOOGLE_SHEETS_API = 'https://script.google.com/macros/s/AKfycbwvbXwdh3xtkbHWsfwDTJ7BNU5A2fwIAWrGZ40j8w2UyzJeKh_lfQ6zcasIDqPOoSSYPQ/exec';
const ADMIN_PIN = '1995';

// ===================== HELPERS =====================
const fetchAPI = async (params = {}) => {
  // params: { action: 'obtenerProductos', ...}
  const qs = new URLSearchParams(params).toString();
  const url = `${GOOGLE_SHEETS_API}?${qs}`;
  const res = await fetch(url);
  return res.json();
};

const formatMoney = (n) => {
  return Number(n || 0).toLocaleString('es-CO');
};

const nowStr = () => new Date().toLocaleString('es-CO');

// ===================== APP =====================
function App(){
  // vistas
  const [screen, setScreen] = useState('home'); // home, clienteLogin, clienteMenu, clientePedidos, clienteConfirmar, adminLogin, admin
  const [loading, setLoading] = useState(false);

  // config (desde Sheets)
  const [config, setConfig] = useState({ numero_wimpy: '573118336562' });

  // cliente / auth OTP
  const [telefono, setTelefono] = useState('');
  const [pinGenerado, setPinGenerado] = useState('');
  const [pinInput, setPinInput] = useState('');
  const [clienteNombre, setClienteNombre] = useState('');
  const [saldoPuntos, setSaldoPuntos] = useState(0);

  // productos + carrito
  const [productos, setProductos] = useState([]);
  const [buscador, setBuscador] = useState('');
  const [categoriaFilter, setCategoriaFilter] = useState('');
  const [cart, setCart] = useState([]);

  // admin
  const [adminPinInput, setAdminPinInput] = useState('');
  const [adminAuth, setAdminAuth] = useState(false);
  const [adminView, setAdminView] = useState('dashboard'); // dashboard, productos, clientes, pedidos, cuentas, config
  const [productosAdmin, setProductosAdmin] = useState([]);
  const [clientesAdmin, setClientesAdmin] = useState([]);
  const [pedidosAdmin, setPedidosAdmin] = useState([]);

  // mensajes
  const [toast, setToast] = useState('');

  useEffect(() => {
    // cargar configuraci√≥n y recursos iniciales
    cargarConfiguracion();
    obtenerProductos();
    if (adminAuth) cargarAdminData();
  }, [adminAuth]);

  // ===================== CONFIG =====================
  const cargarConfiguracion = async () => {
    try{
      const r = await fetchAPI({ action: 'obtenerConfiguracion' });
      if (r.success && r.configuracion){
        setConfig(r.configuracion);
      } else {
        console.warn('No config found, using defaults');
      }
    }catch(e){ console.error('cfg err', e); }
  };

  // ===================== PRODUCTOS =====================
  const obtenerProductos = async () => {
    try{
      const r = await fetchAPI({ action: 'obtenerProductos' });
      if (r.success){
        setProductos(r.productos || []);
        setProductosAdmin(r.productos || []);
      }
    }catch(e){ console.error(e); }
  };

  const addProductToCart = (p) => {
    setCart(prev => {
      const idx = prev.findIndex(x=>x.id===p.id);
      if (idx >= 0){
        const copy = [...prev]; copy[idx].cantidad += 1; return copy;
      }
      return [...prev, { ...p, cantidad: 1 }];
    });
    toastMsg('Agregado al carrito');
  };

  const changeQty = (id, delta) => {
    setCart(prev => {
      const copy = prev.map(x => ({...x}));
      const idx = copy.findIndex(x=>x.id===id);
      if (idx>=0){
        copy[idx].cantidad = Math.max(0, copy[idx].cantidad + delta);
        if (copy[idx].cantidad === 0) copy.splice(idx,1);
      }
      return copy;
    });
  };

  const removeFromCart = (id) => {
    setCart(prev => prev.filter(x=>x.id!==id));
  };

  const totalCart = useMemo(() => {
    return cart.reduce((s,i)=> s + (Number(i.precio||0) * Number(i.cantidad||1)), 0);
  }, [cart]);

  // ===================== CLIENTE - OTP =====================
  const generarPin = async () => {
    if (!telefono) return toastMsg('Ingresa un n√∫mero');
    setLoading(true);
    try{
      const r = await fetchAPI({ action: 'generarOTP', telefono });
      if (r.success){
        setPinGenerado(r.pin);
        setToast(`PIN generado: ${r.pin} (v√°lido 3 min). Ingr√©salo abajo.`);
      } else {
        toastMsg('No se pudo generar PIN');
      }
    }catch(e){
      console.error(e); toastMsg('Error generando PIN');
    }
    setLoading(false);
  };

  const validarPin = async () => {
    if (!telefono || !pinInput) return toastMsg('Ingresa tel√©fono y PIN');
    setLoading(true);
    try{
      const r = await fetchAPI({ action: 'validarOTP', telefono, pin: pinInput });
      if (r.success){
        setClienteNombre(r.nombre || '');
        setSaldoPuntos(r.saldo || 0);
        setScreen('clienteMenu');
        setToast('Ingreso aceptado');
        // limpiar campo pinInput y pinGenerado al ingresar
        setPinInput('');
        setPinGenerado('');
      } else {
        toastMsg(r.message || 'PIN inv√°lido');
      }
    }catch(e){
      console.error(e); toastMsg('Error validando PIN');
    }
    setLoading(false);
  };

  // ===================== CLIENTE - PEDIDOS =====================
  const confirmarPedido = async () => {
    if (!telefono) return toastMsg('Debes ingresar tel√©fono');
    if (cart.length === 0) return toastMsg('Carrito vac√≠o');
    setLoading(true);
    try{
      const detalle = JSON.stringify(cart.map(i=>({ id:i.id, nombre:i.nombre, precio:i.precio, cantidad:i.cantidad })));
      const r = await fetchAPI({ action: 'registrarPedido', telefono, nombre: clienteNombre || '', detalleJSON: detalle, total: totalCart });
      if (r.success){
        // Abrir WhatsApp con mensaje al numero de Wimpy
        const numero = (config.numero_wimpy || config['numero_wimpy'] || '573118336562').replace(/\+/g,'').replace(/\s+/g,'');
        const msg = encodeURIComponent(`Nuevo pedido desde WimpyApp\nCliente: ${clienteNombre || ''}\nTel: ${telefono}\nPedido: ${r.idpedido}\nTotal: $${formatMoney(totalCart)}`);
        // limpiar carrito
        setCart([]);
        // abrir WA
        const waUrl = `https://wa.me/${numero}?text=${msg}`;
        window.open(waUrl, '_blank');
        toastMsg('Pedido registrado. Se abri√≥ WhatsApp para confirmarlo.');
      } else {
        toastMsg('Error registrando pedido');
      }
    }catch(e){
      console.error(e); toastMsg('Error confirmando pedido');
    }
    setLoading(false);
  };

  // ===================== CLIENTE - CONFIRMAR ENTREGA =====================
  const confirmarEntregaCliente = async () => {
    // Pedir id de pedido al cliente: simple flujo ‚Äî mostramos listado de pedidos del usuario (historial) y dejamos confirmar.
    setLoading(true);
    try{
      // obtener historial y filtrar por telefono
      const r = await fetchAPI({ action: 'obtenerHistorial' });
      if (r.success){
        const lista = (r.historial || []).filter(h => h.telefono === telefono && h.estado !== 'entregado');
        if (lista.length === 0){
          toastMsg('No hay pedidos pendientes para confirmar');
        } else {
          // si hay m√°s de uno, pedimos seleccionar; para simplicidad si hay uno lo confirmamos
          const pedido = lista[0];
          const resp = await fetchAPI({ action: 'confirmarEntrega', idpedido: pedido.idpedido, telefono });
          if (resp.success){
            // abrir whatsapp al numero de wimpy con mensaje de confirmacion
            const numero = (config.numero_wimpy || config['numero_wimpy'] || '573118336562').replace(/\+/g,'').replace(/\s+/g,'');
            const msg = encodeURIComponent(`Yo ${pedido.nombre || ''} confirmo que recib√≠ el pedido ${pedido.idpedido}. Gracias Wimpy.`);
            const waUrl = `https://wa.me/${numero}?text=${msg}`;
            window.open(waUrl, '_blank');
            toastMsg('Entrega confirmada. Se abri√≥ WhatsApp.');
          } else {
            toastMsg(resp.message || 'No se pudo confirmar entrega');
          }
        }
      } else {
        toastMsg('No se pudo cargar historial');
      }
    }catch(e){
      console.error(e); toastMsg('Error confirmando entrega');
    }
    setLoading(false);
  };

  // ===================== ADMIN =====================
  const intentarAdminLogin = () => {
    if (adminPinInput === ADMIN_PIN){
      setAdminAuth(true);
      setAdminPinInput('');
      setToast('Sesi√≥n administrativa iniciada');
    } else {
      toastMsg('PIN administrador incorrecto');
    }
  };

  const cargarAdminData = async () => {
    setLoading(true);
    try{
      const r1 = await fetchAPI({ action: 'obtenerProductos' });
      if (r1.success) setProductosAdmin(r1.productos || []);
      const r2 = await fetchAPI({ action: 'obtenerClientes' });
      if (r2.success) setClientesAdmin(r2.clientes || []);
      const r3 = await fetchAPI({ action: 'obtenerHistorial' });
      if (r3.success) setPedidosAdmin(r3.historial || []);
    }catch(e){ console.error(e); }
    setLoading(false);
  };

  // productos admin CRUD
  const agregarProductoAdmin = async (nombre, precio, categoria) => {
    if (!nombre) return toastMsg('Nombre requerido');
    setLoading(true);
    try{
      const r = await fetchAPI({ action: 'agregarProducto', nombre, precio: parseInt(precio||0), categoria });
      if (r.success){ toastMsg('Producto agregado'); obtenerProductos(); cargarAdminData(); }
      else toastMsg('Error agregando producto');
    }catch(e){ console.error(e); toastMsg('Error'); }
    setLoading(false);
  };
  const eliminarProductoAdmin = async (id) => {
    if (!confirm('Eliminar producto?')) return;
    setLoading(true);
    try{ const r = await fetchAPI({ action: 'eliminarProducto', id }); if (r.success){ toastMsg('Eliminado'); obtenerProductos(); cargarAdminData(); } }catch(e){ console.error(e); }
    setLoading(false);
  };

  // configuraci√≥n admin: guardar datos de Wimpy / empresa
  const guardarConfiguracionAdmin = async (obj) => {
    setLoading(true);
    try{
      // guardar con action=guardarWimpy&data=JSON
      const data = encodeURIComponent(JSON.stringify(obj));
      const r = await fetchAPI({ action: 'guardarWimpy', data });
      if (r.success){ toastMsg('Configuraci√≥n guardada'); cargarConfiguracion(); }
      else toastMsg('Error guardando configuraci√≥n');
    }catch(e){ console.error(e); toastMsg('Error'); }
    setLoading(false);
  };

  // generar cuenta de cobro mensual (admin)
  const generarCuentaCobroAdmin = async (mesYYYYMM, codigoEmpresa) => {
    if (!mesYYYYMM) return toastMsg('Formato mes: YYYY-MM');
    setLoading(true);
    try{
      const r = await fetchAPI({ action: 'generarCuentaCobro', mes: mesYYYYMM, codigoEmpresa: codigoEmpresa || config.codigo_empresa || '01' });
      if (r.success){ toastMsg('Cuenta generada: ' + r.consecutivo); window.open(r.driveUrl, '_blank'); }
      else toastMsg('Error generando cuenta');
    }catch(e){ console.error(e); toastMsg('Error'); }
    setLoading(false);
  };

  // crear trigger backup
  const crearTriggerBackupAdmin = async () => {
    setLoading(true);
    try{
      const r = await fetchAPI({ action: 'crearTriggerBackup' });
      if (r.success) toastMsg(r.message || 'Trigger creado');
      else toastMsg('Error creando trigger');
    }catch(e){ console.error(e); toastMsg('Error'); }
    setLoading(false);
  };

  // obtener saldo puntos (cliente)
  const actualizarSaldoPuntos = async (tel) => {
    if (!tel) return;
    try{
      const r = await fetchAPI({ action: 'getSaldoPuntos', telefono: tel });
      if (r.success) setSaldoPuntos(r.saldo || 0);
    }catch(e){ console.error(e); }
  };

  // ===================== UTILIDAD UI =====================
  const toastMsg = (m) => {
    setToast(m);
    setTimeout(()=>setToast(''), 5000);
  };

  // ===================== RENDERS =====================

  // Home: elegir cliente o admin
  if (screen === 'home'){
    return (
      <div className="min-h-screen flex items-center justify-center p-4">
        <div className="w-full max-w-md bg-gray-800 rounded-2xl p-6 shadow-xl border border-gray-700">
          <div className="text-center mb-4">
            <div className="mx-auto w-20 h-20 rounded-full bg-gradient-to-br from-orange-500 to-red-500 flex items-center justify-center text-3xl">üçî</div>
            <h1 className="text-2xl font-bold mt-4">üçî‚òï WimpyApp</h1>
            <p className="text-sm text-gray-400 mt-1">Pedidos, Fidelizaci√≥n y Facturaci√≥n</p>
          </div>

          <div className="space-y-3">
            <button onClick={()=>setScreen('clienteLogin')} className="w-full py-3 rounded-xl bg-gradient-to-r from-emerald-600 to-green-500 font-bold">üë§ Cliente</button>
            <button onClick={()=>setScreen('adminLogin')} className="w-full py-3 rounded-xl bg-gradient-to-r from-orange-500 to-red-500 font-bold">üõ†Ô∏è Administrador</button>
          </div>

          <div className="text-center text-xs text-gray-500 mt-4">Versi√≥n v4.5 ‚Äî Modo oscuro forzado</div>
        </div>

        {toast && <div className="fixed bottom-6 left-1/2 -translate-x-1/2 bg-gray-700 text-white px-4 py-2 rounded-lg shadow">{toast}</div>}
      </div>
    );
  }

  // ========== CLIENTE - LOGIN ==========
  if (screen === 'clienteLogin'){
    return (
      <div className="min-h-screen flex items-center justify-center p-4">
        <div className="w-full max-w-md bg-gray-800 rounded-2xl p-6 shadow-xl border border-gray-700">
          <h2 className="text-xl font-bold mb-4">üë§ Acceso Cliente</h2>
          <label className="text-sm text-gray-300">Tel√©fono (ej: 3118336562)</label>
          <input value={telefono} onChange={(e)=>setTelefono(e.target.value)} className="w-full mt-2 px-4 py-3 rounded-lg bg-gray-900 border border-gray-700" placeholder="3118336562" />

          <div className="flex gap-2 mt-3">
            <button onClick={generarPin} disabled={loading} className="flex-1 py-3 rounded-lg bg-indigo-600 font-semibold">Generar PIN</button>
            <button onClick={()=>{ setScreen('home'); setTelefono(''); }} className="py-3 px-4 rounded-lg bg-gray-700">‚Üê Volver</button>
          </div>

          {pinGenerado && (
            <div className="mt-4 bg-gray-900 p-3 rounded-lg border border-gray-700">
              <div className="text-sm text-gray-300 mb-2">PIN generado (v√°lido 3 min):</div>
              <div className="flex gap-2 items-center">
                <div className="text-lg font-mono px-3 py-2 bg-gray-800 rounded">{pinGenerado}</div>
                <input value={pinInput} onChange={(e)=>setPinInput(e.target.value)} placeholder="Ingresa PIN" className="flex-1 px-3 py-2 rounded bg-gray-900 border border-gray-700" />
                <button onClick={validarPin} className="px-4 py-2 bg-emerald-600 rounded">Ingresar</button>
              </div>
            </div>
          )}

          <div className="text-sm text-gray-500 mt-4">Al ingresar podr√°s ver Pedidos y Confirmar entrega.</div>
        </div>
        {toast && <div className="fixed bottom-6 left-1/2 -translate-x-1/2 bg-gray-700 text-white px-4 py-2 rounded-lg shadow">{toast}</div>}
      </div>
    );
  }

  // ========== CLIENTE - MENU ==========
  if (screen === 'clienteMenu'){
    return (
      <div className="min-h-screen p-4">
        <div className="max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-4">
          <div className="md:col-span-1 bg-gray-800 rounded-xl p-4 border border-gray-700">
            <h3 className="font-bold text-lg">Hola {clienteNombre || telefono}</h3>
            <p className="text-sm text-gray-400">Saldo puntos: <strong>{saldoPuntos}</strong></p>
            <div className="mt-4 space-y-2">
              <button onClick={()=>setScreen('clientePedidos')} className="w-full py-3 rounded-lg bg-indigo-600 font-semibold">üõí Pedidos</button>
              <button onClick={async ()=>{ await confirmarEntregaCliente(); }} className="w-full py-3 rounded-lg bg-emerald-600 font-semibold">üì¶ Confirmar entrega</button>
              <button onClick={()=>{ setScreen('home'); setTelefono(''); setClienteNombre(''); }} className="w-full py-2 rounded-lg bg-gray-700">Cerrar sesi√≥n</button>
            </div>
            <div className="mt-4 text-xs text-gray-500">WimpyApp - {nowStr()}</div>
          </div>

          <div className="md:col-span-2 bg-gray-800 rounded-xl p-4 border border-gray-700">
            <div className="flex items-center justify-between mb-3">
              <div className="flex gap-2">
                <input className="px-3 py-2 rounded bg-gray-900 border border-gray-700" placeholder="Buscar productos..." value={buscador} onChange={(e)=>setBuscador(e.target.value)} />
                <select className="px-3 py-2 rounded bg-gray-900 border border-gray-700" value={categoriaFilter} onChange={(e)=>setCategoriaFilter(e.target.value)}>
                  <option value="">Todas</option>
                  {[...new Set(productos.map(p=>p.categoria).filter(Boolean))].map(c => <option key={c} value={c}>{c}</option>)}
                </select>
              </div>
              <div>
                <div className="text-sm text-gray-300">Total carrito: <strong>${formatMoney(totalCart)}</strong></div>
                <button onClick={()=>document.getElementById('openCartBtn').click()} className="mt-2 px-3 py-2 bg-yellow-500 text-black rounded">Ver carrito</button>
              </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
              {productos.filter(p => p.activo).filter(p => (p.nombre.toLowerCase().includes(buscador.toLowerCase()) || !buscador)).filter(p => (!categoriaFilter || p.categoria === categoriaFilter)).map(p => (
                <div key={p.id} className="bg-gray-900 p-3 rounded-lg border border-gray-700 flex items-start justify-between">
                  <div>
                    <div className="font-semibold">{p.nombre}</div>
                    <div className="text-xs text-gray-400">{p.categoria}</div>
                  </div>
                  <div className="text-right">
                    <div className="font-bold">${formatMoney(p.precio)}</div>
                    <button onClick={()=>addProductToCart(p)} className="mt-2 px-3 py-1 rounded bg-indigo-600 text-white">Agregar</button>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>

        {/* carrito modal (simple) */}
        <button id="openCartBtn" className="hidden" onClick={()=>{
          const el = document.getElementById('cartModal');
          if (el) el.classList.remove('hidden');
        }}>open</button>
        <div id="cartModal" className="hidden fixed inset-0 bg-black/60 flex items-end md:items-center justify-center p-4">
          <div className="w-full max-w-md bg-gray-800 rounded-t-xl md:rounded-xl p-4 border border-gray-700">
            <div className="flex items-center justify-between mb-3">
              <h3 className="font-bold">Carrito</h3>
              <button onClick={()=>{ document.getElementById('cartModal').classList.add('hidden'); }} className="text-gray-400">Cerrar</button>
            </div>

            <div className="space-y-2 max-h-64 overflow-y-auto">
              {cart.length === 0 && <div className="text-gray-400">Carrito vac√≠o</div>}
              {cart.map(i => (
                <div key={i.id} className="flex items-center justify-between bg-gray-900 p-2 rounded">
                  <div>
                    <div className="font-semibold">{i.nombre}</div>
                    <div className="text-xs text-gray-400">x{i.cantidad} ‚Ä¢ ${formatMoney(i.precio)}</div>
                  </div>
                  <div className="flex items-center gap-2">
                    <button onClick={()=>changeQty(i.id,-1)} className="px-2 py-1 bg-gray-700 rounded">-</button>
                    <div className="w-6 text-center">{i.cantidad}</div>
                    <button onClick={()=>changeQty(i.id,1)} className="px-2 py-1 bg-gray-700 rounded">+</button>
                    <button onClick={()=>removeFromCart(i.id)} className="ml-2 text-red-400">‚úï</button>
                  </div>
                </div>
              ))}
            </div>

            <div className="mt-4">
              <div className="flex items-center justify-between">
                <div>Total:</div>
                <div className="font-bold">${formatMoney(totalCart)}</div>
              </div>

              <div className="mt-3 grid grid-cols-2 gap-2">
                <button onClick={confirmarPedido} className="py-3 rounded bg-emerald-600">Confirmar pedido</button>
                <button onClick={()=>{ setCart([]); toastMsg('Carrito limpiado'); }} className="py-3 rounded bg-gray-700">Limpiar</button>
              </div>
            </div>

          </div>
        </div>

        {toast && <div className="fixed bottom-6 left-1/2 -translate-x-1/2 bg-gray-700 text-white px-4 py-2 rounded-lg shadow">{toast}</div>}
      </div>
    );
  }

  // ========== ADMIN - LOGIN ==========
  if (screen === 'adminLogin'){
    return (
      <div className="min-h-screen flex items-center justify-center p-4">
        <div className="w-full max-w-md bg-gray-800 rounded-2xl p-6 shadow-xl border border-gray-700">
          <h2 className="text-xl font-bold mb-4">üîí Panel Administrador</h2>
          <input placeholder="PIN administrador" value={adminPinInput} onChange={(e)=>setAdminPinInput(e.target.value)} className="w-full px-4 py-3 rounded bg-gray-900 border border-gray-700" />
          <div className="flex gap-2 mt-3">
            <button onClick={intentarAdminLogin} className="flex-1 py-3 rounded bg-orange-500 font-semibold">Ingresar</button>
            <button onClick={()=>setScreen('home')} className="py-3 px-4 rounded bg-gray-700">Volver</button>
          </div>
          <div className="text-sm text-gray-500 mt-3">PIN por defecto: 1995</div>
        </div>
        {toast && <div className="fixed bottom-6 left-1/2 -translate-x-1/2 bg-gray-700 text-white px-4 py-2 rounded-lg shadow">{toast}</div>}
      </div>
    );
  }

  // ========== ADMIN - PANEL ==========
  if (adminAuth && screen !== 'home'){
    return (
      <div className="min-h-screen p-4">
        <div className="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-6 gap-4">
          <aside className="md:col-span-1 bg-gray-800 rounded-xl p-4 border border-gray-700">
            <div className="font-bold text-lg">Admin</div>
            <div className="text-sm text-gray-400">WimpyApp</div>
            <nav className="mt-4 space-y-2">
              <button className={"w-full text-left px-3 py-2 rounded " + (adminView==='dashboard'?'bg-gray-700':'')} onClick={()=>setAdminView('dashboard')}>üìä Dashboard</button>
              <button className={"w-full text-left px-3 py-2 rounded " + (adminView==='productos'?'bg-gray-700':'')} onClick={()=>setAdminView('productos')}>üßæ Productos</button>
              <button className={"w-full text-left px-3 py-2 rounded " + (adminView==='clientes'?'bg-gray-700':'')} onClick={()=>setAdminView('clientes')}>üë• Clientes</button>
              <button className={"w-full text-left px-3 py-2 rounded " + (adminView==='pedidos'?'bg-gray-700':'')} onClick={()=>setAdminView('pedidos')}>üì¶ Pedidos</button>
              <button className={"w-full text-left px-3 py-2 rounded " + (adminView==='cuentas'?'bg-gray-700':'')} onClick={()=>setAdminView('cuentas')}>üßæ Cuentas de Cobro</button>
              <button className={"w-full text-left px-3 py-2 rounded " + (adminView==='config'?'bg-gray-700':'')} onClick={()=>setAdminView('config')}>‚öôÔ∏è Configuraci√≥n</button>
              <button onClick={()=>{ setAdminAuth(false); setScreen('home'); toastMsg('Sesi√≥n cerrada'); }} className="w-full text-left px-3 py-2 rounded bg-red-600 mt-4">Cerrar sesi√≥n</button>
            </nav>
          </aside>

          <main className="md:col-span-5 bg-gray-800 rounded-xl p-4 border border-gray-700">
            {adminView === 'dashboard' && (
              <div>
                <h3 className="text-xl font-bold mb-3">üìä Dashboard</h3>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                  <div className="p-4 bg-gray-900 rounded">
                    <div className="text-sm text-gray-400">Productos</div>
                    <div className="text-2xl font-bold">{productosAdmin.length}</div>
                  </div>
                  <div className="p-4 bg-gray-900 rounded">
                    <div className="text-sm text-gray-400">Clientes</div>
                    <div className="text-2xl font-bold">{clientesAdmin.length}</div>
                  </div>
                  <div className="p-4 bg-gray-900 rounded">
                    <div className="text-sm text-gray-400">Pedidos</div>
                    <div className="text-2xl font-bold">{pedidosAdmin.length}</div>
                  </div>
                </div>
              </div>
            )}

            {adminView === 'productos' && (
              <div>
                <h3 className="text-xl font-bold mb-3">üßæ Productos</h3>

                <ProductAdminList productos={productosAdmin} onEliminar={eliminarProductoAdmin} onRefrescar={() => { obtenerProductos(); cargarAdminData(); }} onAgregar={agregarProductoAdmin} />
              </div>
            )}

            {adminView === 'clientes' && (
              <div>
                <h3 className="text-xl font-bold mb-3">üë• Clientes</h3>
                <div className="space-y-2">
                  {clientesAdmin.length === 0 && <div className="text-gray-400">No hay clientes</div>}
                  {clientesAdmin.map(c => (
                    <div key={c.telefono} className="p-3 bg-gray-900 rounded flex items-center justify-between">
                      <div>
                        <div className="font-semibold">{c.nombre}</div>
                        <div className="text-xs text-gray-400">{c.telefono} ‚Ä¢ {c.email}</div>
                      </div>
                      <div className="text-sm text-gray-300">Puntos: {c.puntosTotales}</div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {adminView === 'pedidos' && (
              <div>
                <h3 className="text-xl font-bold mb-3">üì¶ Pedidos</h3>
                <div className="space-y-2 max-h-96 overflow-y-auto">
                  {pedidosAdmin.length === 0 && <div className="text-gray-400">Sin pedidos</div>}
                  {pedidosAdmin.slice().reverse().map(p => (
                    <div key={p.idpedido} className="p-3 bg-gray-900 rounded flex items-start justify-between">
                      <div>
                        <div className="font-semibold">{p.nombre || p.telefono}</div>
                        <div className="text-xs text-gray-400">{p.fechaPedido} ‚Ä¢ {p.idpedido}</div>
                        <div className="text-xs mt-2 text-gray-300">Productos: {p.productosJSON}</div>
                      </div>
                      <div className="text-right">
                        <div className="text-sm text-gray-300">Estado: {p.estado}</div>
                        <div className="text-lg font-bold mt-2">${formatMoney(p.valorTotal)}</div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {adminView === 'cuentas' && (
              <div>
                <h3 className="text-xl font-bold mb-3">üßæ Generar Cuenta de Cobro</h3>
                <CuentaCobroForm onGenerar={generarCuentaCobroAdmin} />
                <div className="text-xs text-gray-400 mt-3">Consecutivo: AAAAMM + c√≥digo empresa + correlativo (ej: 2025100101)</div>
              </div>
            )}

            {adminView === 'config' && (
              <div>
                <h3 className="text-xl font-bold mb-3">‚öôÔ∏è Configuraci√≥n</h3>
                <ConfigForm config={config} onGuardar={guardarConfiguracionAdmin} crearTriggerBackup={crearTriggerBackupAdmin} onRefrescar={cargarConfiguracion} />
              </div>
            )}

          </main>
        </div>

        {toast && <div className="fixed bottom-6 left-1/2 -translate-x-1/2 bg-gray-700 text-white px-4 py-2 rounded-lg shadow">{toast}</div>}
      </div>
    );
  }

  return null;
}

/* ================== COMPONENTES ================== */

function ProductAdminList({ productos, onEliminar, onRefrescar, onAgregar }){
  const [nombre, setNombre] = useState('');
  const [precio, setPrecio] = useState('');
  const [cat, setCat] = useState('');
  return (
    <div>
      <div className="mb-3 grid grid-cols-1 md:grid-cols-4 gap-2">
        <input value={nombre} onChange={(e)=>setNombre(e.target.value)} placeholder="Nombre" className="px-3 py-2 rounded bg-gray-900 border border-gray-700" />
        <input value={precio} onChange={(e)=>setPrecio(e.target.value)} placeholder="Precio (entero)" type="number" className="px-3 py-2 rounded bg-gray-900 border border-gray-700" />
        <input value={cat} onChange={(e)=>setCat(e.target.value)} placeholder="Categor√≠a" className="px-3 py-2 rounded bg-gray-900 border border-gray-700" />
        <button onClick={()=>{ onAgregar(nombre, precio, cat); setNombre(''); setPrecio(''); setCat(''); }} className="px-3 py-2 rounded bg-emerald-600">+ Agregar</button>
      </div>

      <div className="space-y-2">
        {productos.length === 0 && <div className="text-gray-400">No hay productos</div>}
        {productos.map(p => (
          <div key={p.id} className="p-3 bg-gray-900 rounded flex items-center justify-between">
            <div>
              <div className="font-semibold">{p.nombre}</div>
              <div className="text-xs text-gray-400">{p.categoria}</div>
            </div>
            <div className="flex items-center gap-2">
              <div className="font-bold">${formatMoney(p.precio)}</div>
              <button onClick={()=>onEliminar(p.id)} className="px-3 py-1 rounded bg-red-600">Eliminar</button>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}

function CuentaCobroForm({ onGenerar }){
  const [mes, setMes] = useState(() => {
    const d = new Date(); return `${d.getFullYear()}-${('0'+(d.getMonth()+1)).slice(-2)}`;
  });
  const [codigo, setCodigo] = useState('');
  return (
    <div className="bg-gray-900 p-4 rounded">
      <div className="grid grid-cols-1 md:grid-cols-3 gap-2">
        <input type="month" value={mes} onChange={(e)=>setMes(e.target.value)} className="px-3 py-2 rounded bg-gray-800 border border-gray-700" />
        <input placeholder="C√≥digo empresa (ej: 01)" value={codigo} onChange={(e)=>setCodigo(e.target.value)} className="px-3 py-2 rounded bg-gray-800 border border-gray-700" />
        <button onClick={()=>onGenerar(mes, codigo)} className="px-3 py-2 rounded bg-indigo-600">Generar PDF</button>
      </div>
    </div>
  );
}

function ConfigForm({ config, onGuardar, crearTriggerBackup, onRefrescar }){
  const [form, setForm] = useState(config || {});
  useEffect(()=> setForm(config || {}), [config]);
  const onChange = (k,v) => setForm({...form, [k]: v});
  return (
    <div className="bg-gray-900 p-4 rounded space-y-3">
      <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
        <input value={form.nombre_wimpy || ''} onChange={(e)=>onChange('nombre_wimpy', e.target.value)} className="px-3 py-2 rounded bg-gray-800" placeholder="Nombre Wimpy" />
        <input value={form.nit_wimpy || ''} onChange={(e)=>onChange('nit_wimpy', e.target.value)} className="px-3 py-2 rounded bg-gray-800" placeholder="NIT Wimpy" />
        <input value={form.direccion_wimpy || ''} onChange={(e)=>onChange('direccion_wimpy', e.target.value)} className="px-3 py-2 rounded bg-gray-800" placeholder="Direcci√≥n Wimpy" />
        <input value={form.correo_wimpy || ''} onChange={(e)=>onChange('correo_wimpy', e.target.value)} className="px-3 py-2 rounded bg-gray-800" placeholder="Correo Wimpy" />
        <input value={form.numero_wimpy || ''} onChange={(e)=>onChange('numero_wimpy', e.target.value)} className="px-3 py-2 rounded bg-gray-800" placeholder="N√∫mero WhatsApp Wimpy" />
        <input value={form.codigo_empresa || ''} onChange={(e)=>onChange('codigo_empresa', e.target.value)} className="px-3 py-2 rounded bg-gray-800" placeholder="C√≥digo empresa (ej: 01)" />
      </div>

      <div className="flex gap-2">
        <button onClick={()=>onGuardar(form)} className="px-3 py-2 rounded bg-emerald-600">Guardar</button>
        <button onClick={()=>crearTriggerBackup()} className="px-3 py-2 rounded bg-indigo-600">Activar Backup Diario</button>
        <button onClick={()=>onRefrescar()} className="px-3 py-2 rounded bg-gray-700">Refrescar</button>
      </div>
      <div className="text-xs text-gray-400">Logo/firma: coloca el ID de Drive en la configuraci√≥n (logo_wimpy / firma_digital). Si no existen, no genera error.</div>
    </div>
  );
}

/* ============ Renderizar app ============ */
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);

  </script>
</body>
</html>